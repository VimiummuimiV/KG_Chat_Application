// ==UserScript==
// @name         KG_Chat_Application
// @namespace    klavogonki
// @version      1.0.0
// @description  Enhance the chat abilities
// @author       Patcher
// @match        *://klavogonki.ru/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=klavogonki.ru
// @grant        none
// ==/UserScript==

(()=>{"use strict";var t={56:(t,e,n)=>{t.exports=function(t){var e=n.nc;e&&t.setAttribute("nonce",e)}},72:t=>{var e=[];function n(t){for(var n=-1,o=0;o<e.length;o++)if(e[o].identifier===t){n=o;break}return n}function o(t,o){for(var a={},r=[],s=0;s<t.length;s++){var c=t[s],l=o.base?c[0]+o.base:c[0],d=a[l]||0,m="".concat(l," ").concat(d);a[l]=d+1;var p=n(m),h={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)e[p].references++,e[p].updater(h);else{var u=i(h,o);o.byIndex=s,e.splice(s,0,{identifier:m,updater:u,references:1})}r.push(m)}return r}function i(t,e){var n=e.domAPI(e);n.update(t);return function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;n.update(t=e)}else n.remove()}}t.exports=function(t,i){var a=o(t=t||[],i=i||{});return function(t){t=t||[];for(var r=0;r<a.length;r++){var s=n(a[r]);e[s].references--}for(var c=o(t,i),l=0;l<a.length;l++){var d=n(a[l]);0===e[d].references&&(e[d].updater(),e.splice(d,1))}a=c}}},113:t=>{t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}},208:(t,e,n)=>{n.d(e,{A:()=>s});var o=n(601),i=n.n(o),a=n(314),r=n.n(a)()(i());r.push([t.id,":root {\n  --border-radius: 0.2em;\n  --min-chat-width: 250px;\n  --min-chat-height: 200px;\n  --user-list-width: 250px;\n}\n\n/* Main chat container */\n#chat-container {\n  opacity: 1;\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  height: 300px;\n  background: #1e1e1e !important;\n  border-radius: var(--border-radius) !important;\n  display: flex;\n  font-family: sans-serif;\n  color: #e0e0e0 !important;\n  z-index: 999;\n  min-width: var(--min-chat-width) !important;\n  min-height: var(--min-chat-height) !important;\n  box-sizing: border-box;\n  max-width: 100vw;\n  overflow: hidden;\n  transition: transform 0.15s ease-out !important;\n}\n\n/* Responsive: hide user list on small screens */\n@media (max-width: 750px) {\n  #chat-container .user-list-container {\n    display: none !important;\n  }\n\n  #chat-container .chat-wrapper {\n    width: 100% !important;\n    border-right: none !important;\n  }\n}\n\n@media (max-width: 550px) {\n  #chat-container .message {\n    flex-direction: column !important;\n    margin-bottom: 1em !important;\n  }\n}\n\n#chat-container.hidden-chat {\n  transform: translateY(calc(100% - 25px)) !important;\n}\n\n#chat-container.visible-chat {\n  transform: translateY(0) !important;\n}\n\n/* Resize handles */\n#chat-container .resize-handle {\n  position: absolute !important;\n  background: transparent !important;\n  z-index: 1000 !important;\n}\n\n#chat-container .resize-handle.top {\n  top: -3px !important;\n  left: 0 !important;\n  right: 0 !important;\n  height: 6px !important;\n  cursor: ns-resize !important;\n}\n\n#chat-container .resize-handle.left {\n  left: -3px !important;\n  top: 0 !important;\n  bottom: 0 !important;\n  width: 6px !important;\n  cursor: ew-resize !important;\n}\n\n#chat-container .resize-handle.right {\n  right: -3px !important;\n  top: 0 !important;\n  bottom: 0 !important;\n  width: 6px !important;\n  cursor: ew-resize !important;\n}\n\n/* Chat wrapper: two-column layout */\n#chat-container .chat-wrapper {\n  display: flex !important;\n  flex-direction: row !important;\n  flex: 1 !important;\n  min-width: var(--min-chat-width) !important;\n  overflow: hidden !important;\n}\n\n/* Left column: messages & input */\n#chat-container .chat-content {\n  background: #1e1e1e !important;\n  display: flex !important;\n  flex-direction: column !important;\n  flex: 1 !important;\n  overflow: hidden !important;\n}\n\n/* Messages panel takes most of the space */\n#chat-container .messages-panel {\n  flex: 1 !important;\n  overflow-y: auto !important;\n  padding: 1em !important;\n  display: flex !important;\n  flex-direction: column !important;\n  gap: 0.6em !important;\n}\n\n/* Input container at bottom */\n#chat-container .input-container {\n  display: flex !important;\n  padding: 1em !important;\n  gap: 0.5em !important;\n  border-top: 1px solid #333 !important;\n}\n\n#chat-container #message-input {\n  flex: 1 !important;\n  background: #2a2a2a !important;\n  color: #e0e0e0 !important;\n  padding: 0.5em !important;\n  border-radius: var(--border-radius) !important;\n  min-width: 0 !important;\n  border: none !important;\n}\n\n/* Right column: user list container */\n#chat-container .user-list-container {\n  margin-top: 20px;\n  width: var(--user-list-width) !important;\n  min-width: var(--user-list-width) !important;\n  max-width: var(--user-list-width) !important;\n  overflow-y: auto !important;\n  overflow-x: hidden !important;\n  padding: 1em !important;\n  background: #1e1e1e !important;\n  border-left: 1px solid #333 !important;\n}\n\n/* Header toggle button */\n#chat-container .header-button {\n  cursor: pointer !important;\n  position: absolute !important;\n  top: 0 !important;\n  width: 25px !important;\n  height: 25px !important;\n  z-index: 5 !important;\n}\n\n#chat-container .filled-button {\n  border: none !important;\n  background-color: transparent !important;\n}\n\n#chat-container .filled-button:hover {\n  filter: brightness(1.2) !important;\n}\n\n#chat-container .chat-toggle-button {\n  right: 0 !important;\n}\n\n/* Drag area for floating the chat */\n#chat-container .chat-drag-area {\n  position: absolute !important;\n  top: 0 !important;\n  left: 0 !important;\n  right: 0 !important;\n  height: 25px !important;\n  cursor: move !important;\n  background-color: rgba(22, 22, 22, 0.8) !important;\n}\n\n/* Specific styling for floating chats */\n.floating-chat {\n  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3) !important;\n}\n\n/* Message styles */\n#chat-container .message {\n  display: flex;\n  flex-direction: row;\n  padding: 0.08em !important;\n  border-radius: var(--border-radius) !important;\n  width: fit-content !important;\n  max-width: 100% !important;\n  word-break: break-word !important;\n}\n\n#chat-container .message.sent {\n  background: #293e2985 !important;\n  border: 1px solid #293e29 !important;\n}\n\n#chat-container .message-info {\n  white-space: nowrap !important;\n  font-size: 0.8em !important;\n  color: #b0b0b0 !important;\n  line-height: 1.5em !important;\n  margin-right: 1.5em !important;\n}\n\n/* User list item styles */\n#chat-container .user-item {\n  display: flex !important;\n  align-items: center !important;\n  padding: 0.2em !important;\n  border-radius: var(--border-radius) !important;\n  max-width: 100% !important;\n  text-overflow: ellipsis !important;\n}\n\n#chat-container .user-avatar {\n  display: flex !important;\n  justify-content: center !important;\n  align-items: center !important;\n  width: 24px !important;\n  height: 24px !important;\n  font-size: 18px !important;\n  border-radius: 0.1em !important;\n  margin-right: 1em !important;\n  text-align: center !important;\n  line-height: 24px !important;\n  flex-shrink: 0 !important;\n}\n\n#chat-container .user-avatar.image-avatar {\n  cursor: pointer !important;\n  transform-origin: left !important;\n  transition: transform 0.15s ease-out !important;\n}\n\n#chat-container .user-avatar.image-avatar:hover {\n  transform: scale(2) !important;\n}\n\n#chat-container .user-avatar.svg-avatar {\n  filter: grayscale(0.5) !important;\n}\n\n#chat-container .user-info {\n  flex: 1 !important;\n  min-width: 0 !important;\n  overflow: hidden !important;\n  text-overflow: ellipsis !important;\n  white-space: nowrap !important;\n}\n\n#chat-container .user-meta {\n  font-size: 0.8em !important;\n  color: #b0b0b0 !important;\n  overflow: hidden !important;\n  text-overflow: ellipsis !important;\n  white-space: nowrap !important;\n}\n\n#chat-container .game-link {\n  color: burlywood !important;\n  text-decoration: none !important;\n  transition: color 0.15s !important;\n}\n\n#chat-container .role-moderator {\n  color: #ff7e7e !important;\n}\n\n#chat-container .role-participant {\n  color: #7ed4ff !important;\n}\n\n#chat-container .role-visitor {\n  color: #b0b0b0 !important;\n}",""]);const s=r},314:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var n="",o=void 0!==e[5];return e[4]&&(n+="@supports (".concat(e[4],") {")),e[2]&&(n+="@media ".concat(e[2]," {")),o&&(n+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),n+=t(e),o&&(n+="}"),e[2]&&(n+="}"),e[4]&&(n+="}"),n})).join("")},e.i=function(t,n,o,i,a){"string"==typeof t&&(t=[[null,t,void 0]]);var r={};if(o)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(r[c]=!0)}for(var l=0;l<t.length;l++){var d=[].concat(t[l]);o&&r[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),e.push(d))}},e}},540:t=>{t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},601:t=>{t.exports=function(t){return t[1]}},659:t=>{var e={};t.exports=function(t,n){var o=function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}e[t]=n}return e[t]}(t);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},825:t=>{t.exports=function(t){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=t.insertStyleElement(t);return{update:function(n){!function(t,e,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,i&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var a=n.sourceMap;a&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),e.styleTagTransform(o,t,e.options)}(e,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}}},e={};function n(o){var i=e[o];if(void 0!==i)return i.exports;var a=e[o]={id:o,exports:{}};return t[o](a,a.exports,n),a.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var o in e)n.o(e,o)&&!n.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.nc=void 0;const o="http://www.w3.org/2000/svg",i=`\n  <svg xmlns="${o}" \n      width="24" \n      height="24" \n      viewBox="0 0 250 250">\n    <path fill="#096AD9" d="M22.32 98.04l-19.04 -87.15c-0.75,-3.46 0.48,-6.84 3.29,-9 2.81,-2.17 6.39,-2.49 9.55,-0.87l225.95 116.02c3.07,1.57 4.87,4.52 4.87,7.96 0,3.44 -1.8,6.39 -4.87,7.96l-225.95 116.02c-3.16,1.62 -6.74,1.3 -9.55,-0.87 -2.81,-2.16 -4.04,-5.54 -3.29,-9l19.04 -87.15c0.79,-3.62 3.53,-6.26 7.18,-6.91l102.6 -18.19c0.91,-0.16 1.56,-0.94 1.56,-1.86 0,-0.92 -0.65,-1.7 -1.56,-1.86l-102.6 -18.19c-3.65,-0.65 -6.39,-3.29 -7.18,-6.91z"/>\n  </svg>\n`,a=`\n  <svg xmlns="${o}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250" \n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n      <path fill="#82B32A" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm45.71 70.24l32.67 32.67 32.67 -32.67c2.73,-2.73 7.18,-2.73 9.91,0l12.18 12.18c2.73,2.73 2.73,7.18 0,9.91l-32.67 32.67 32.67 32.66c2.73,2.74 2.73,7.19 0,9.92l-12.18 12.18c-2.73,2.73 -7.18,2.73 -9.91,0l-32.67 -32.67 -32.67 32.67c-2.73,2.73 -7.18,2.73 -9.91,0l-12.18 -12.18c-2.73,-2.73 -2.73,-7.18 0,-9.92l32.67 -32.66 -32.67 -32.67c-2.73,-2.73 -2.73,-7.18 0,-9.91l12.18 -12.18c2.73,-2.73 7.18,-2.73 9.91,0z"/>\n  </svg>\n`,r=`\n  <svg xmlns="${o}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250" \n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n      <path fill="#B34A2A" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm15.5 135.79l57.92 -57.93c2.73,-2.73 7.19,-2.72 9.92,0.01l57.92 57.92c2.73,2.73 2.73,7.18 0,9.91l-12.18 12.18c-2.73,2.73 -7.18,2.73 -9.92,0l-35.82 -35.83c-2.73,-2.73 -7.19,-2.73 -9.92,0l-35.82 35.83c-2.74,2.73 -7.19,2.73 -9.92,0l-12.18 -12.18c-2.73,-2.73 -2.73,-7.18 0,-9.91z"/>\n  </svg>\n`;var s=n(72),c=n.n(s),l=n(825),d=n.n(l),m=n(659),p=n.n(m),h=n(56),u=n.n(h),g=n(540),f=n.n(g),b=n(113),y=n.n(b),v=n(208),x={};x.styleTagTransform=y(),x.setAttributes=u(),x.insert=p().bind(null,"head"),x.domAPI=d(),x.insertStyleElement=f();c()(v.A,x);v.A&&v.A.locals&&v.A.locals;const w="https://klavogonki.ru",E=`${w}/g/?gmid=`,$=`${w}/xmpp-httpbind/`,S=200,I="748754#Душа_Чата",k=["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😏","😐","😑","😒","😓","😔","😕","😖","😗","😘","😙","😚","😜","😝","😛","🤑","🤗","🤔","🤐","🤨","😣","😥","😮","🤯","😳","😱","😨","😰","😢","🤪","😵","😲","🤤","😷","🤒","🤕","🤢","🤧","😇","🥳","🥺","😬","😴","😌","🤥","🥴","🥵","🥶","🤧","🤭","🤫","😠","😡","😳","😞","😟","😕","🐱","😺","😸","😹","😻","😼","😽","🙀","😿","😾","🐶","🐭","🐹","🐰","🦊","🐻","🐼","🐨","🐯","🦁","🐮","🐷","🐸","🐵","🙈","🙉","🙊","🐔","🦄"];let M=null;function R(t){switch(t.toLowerCase()){case"moderator":return 1;case"participant":return 2;case"visitor":return 3;default:return 4}}function C(t){return[...t].sort(((t,e)=>R(t.role)-R(e.role))).map((t=>{const e=t.avatar?`<img class="user-avatar image-avatar" src="${w}${t.avatar.replace(".png","_big.png")}" alt="${t.login}'s avatar">`:`<span class="user-avatar svg-avatar">${function(){let t;do{t=k[Math.floor(Math.random()*k.length)]}while(t===M);return M=t,t}()}</span>`,n=t.game?` | Game: <a href="${E}${t.game}" class="game-link" target="_blank">${t.game} 🎮</a>`:"",o=`role-${t.role.toLowerCase()}`;return`\n      <div class="user-item">\n        ${e}\n        <div class="user-info">\n          <div>${t.login}</div>\n          <div class="user-meta">Role: <span class="${o}">${t.role}</span>${n}</div>\n        </div>\n      </div>\n    `})).join("")}function L(t,e,n){return Math.min(Math.max(t,e),n)}function T(){const t=localStorage.getItem("chatState");return t?JSON.parse(t):{height:300,width:Math.min(window.innerWidth,600),left:0,floating:!1,top:window.innerHeight-300}}function B(t){localStorage.setItem("chatState",JSON.stringify(t))}function N(){const t=document.querySelector("#chat-container .chat-wrapper");if(!t)return;const e=t.offsetWidth<=750,n=document.querySelector("#chat-container .user-list-container");n&&(n.style.display=e?"none":""),document.querySelectorAll("#chat-container .message").forEach((t=>{t.style.flexDirection=e?"column":"row",t.style.marginBottom=e?"1em":"0"}))}function j(){const t=document.getElementById("chat-container"),e=T(),n=window.innerWidth,o=window.innerHeight,i=getComputedStyle(document.documentElement),a=parseInt(i.getPropertyValue("--min-chat-width"))||250,r=parseInt(i.getPropertyValue("--min-chat-height"))||200;t.style.width=Math.min(n,Math.max(a,e.width))+"px",t.style.height=Math.min(o,Math.max(r,e.height))+"px",t.style.left=L(e.left,0,n-t.offsetWidth)+"px",e.floating?(t.style.top=L(e.top,0,o-t.offsetHeight)+"px",t.style.bottom="",t.classList.add("floating-chat")):(t.style.bottom="0",t.style.top="",t.classList.remove("floating-chat")),N()}let A,q,z,P,U=!1;document.addEventListener("mousedown",(t=>{if(!t.target.closest(".chat-drag-area"))return;U=!0;const e=document.getElementById("chat-container");let n=T();if(!n.floating){const t=window.innerHeight-e.offsetHeight;e.style.top=t+"px",e.style.bottom="",n.top=t,n.floating=!0,e.classList.add("floating-chat"),B(n)}A=t.clientX,q=t.clientY,z=e.offsetLeft,P=parseInt(e.style.top)||e.getBoundingClientRect().top,document.body.style.userSelect="none"})),document.addEventListener("mousemove",(t=>{if(!U)return;const e=document.getElementById("chat-container"),n=window.innerWidth,o=window.innerHeight,i=t.clientX-A,a=t.clientY-q,r=L(z+i,0,n-e.offsetWidth),s=L(P+a,0,o-e.offsetHeight);e.style.left=r+"px",e.style.top=s+"px";const c=T();c.left=r,c.top=s,c.floating=!0,B(c)})),document.addEventListener("mouseup",(()=>{if(!U)return;U=!1;const t=document.getElementById("chat-container"),e=window.innerWidth,n=window.innerHeight,o=t.getBoundingClientRect(),i=o.left<0||o.top<0||o.right>e||o.bottom>n,a=n-o.bottom<50;let r=T();i||a?(t.style.top="",t.style.bottom="0",r.floating=!1,t.classList.remove("floating-chat")):(r.floating=!0,r.top=o.top,t.classList.add("floating-chat")),B(r),document.body.style.userSelect=""}));let H,W,O,_,D,J,F=!1,Y=null;document.addEventListener("mousedown",(t=>{const e=t.target.closest(".resize-handle");if(!e)return;F=!0,Y=e.classList[1];const n=document.getElementById("chat-container");H=t.clientX,W=t.clientY,O=n.offsetWidth,_=n.offsetHeight,D=n.offsetLeft,T().floating&&(J=parseInt(n.style.top)||n.getBoundingClientRect().top),document.body.style.userSelect="none"})),document.addEventListener("mousemove",(t=>{if(!F)return;const e=document.getElementById("chat-container"),n=t.clientX-H,o=t.clientY-W,i=window.innerWidth,a=window.innerHeight,r=getComputedStyle(document.documentElement),s=parseInt(r.getPropertyValue("--min-chat-width"))||250,c=parseInt(r.getPropertyValue("--min-chat-height"))||200;let l=T();switch(Y){case"top":{const t=Math.max(c,_-o);if(l.floating){let n=J+o;n=L(n,0,a-t),e.style.top=n+"px",l.top=n}else e.style.top="",e.style.bottom="0";e.style.height=t+"px",l.height=t;break}case"left":{const t=Math.max(s,O-n),o=L(D+n,0,i-s);e.style.width=t+"px",e.style.left=o+"px",l.width=t,l.left=o;break}case"right":{const t=i-e.getBoundingClientRect().left,o=Math.min(t,Math.max(s,O+n));e.style.width=o+"px",l.width=o;break}}B(l),N()})),document.addEventListener("mouseup",(()=>{F=!1,document.body.style.userSelect=""}));class X{constructor(){this.container=document.getElementById("user-list"),this.activeUsers=new Map}updatePresence(t){const e=(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("presence");if(t.includes('<presence id="pres_1"'))return console.log("🔄 Initial room join detected, requesting full roster"),void this.requestFullRoster();let n=!1;for(let t=0;t<e.length;t++){const o=e[t],i=o.getAttribute("from");if("unavailable"===o.getAttribute("type")){this.activeUsers.has(i)&&(console.log(`🚪 User left: ${this.activeUsers.get(i).login||i}`),this.activeUsers.delete(i),n=!0);continue}let a=null;const r=o.getElementsByTagName("x");for(let t=0;t<r.length;t++)if("klavogonki:userdata"===r[t].namespaceURI){a=r[t];break}if(!a){console.log(`⚠️ No klavogonki:userdata found for presence from: ${i}`);continue}const s=a.getElementsByTagName("user")[0];if(!s){console.log(`⚠️ No user node found in klavogonki:userdata for presence from: ${i}`);continue}const c=s.getElementsByTagName("login")[0]?.textContent||"Anonymous",l=s.getElementsByTagName("avatar")[0]?.textContent,d=s.getElementsByTagName("background")[0]?.textContent||"#777",m=a.getElementsByTagName("game_id")[0],p=m?m.textContent:null,h={jid:i,login:c,avatar:l,color:d,role:o.getElementsByTagName("item")[0]?.getAttribute("role")||"participant",game:p},u=this.activeUsers.get(i);u&&JSON.stringify(u)===JSON.stringify(h)||(console.log(`👤 User ${u?"updated":"joined"}: ${c}`),this.activeUsers.set(i,h),n=!0)}n&&(console.log(`📋 Current active users: ${this.activeUsers.size}`),this.updateUI())}async requestFullRoster(){console.log("📑 Would request full roster here (using existing data for now)"),this.updateUI()}updateUI(){console.log(`🖥️ Updating UI with ${this.activeUsers.size} users`),this.container.innerHTML=C(Array.from(this.activeUsers.values()))}}const V={userManager:null,messages:function(){const t=localStorage.getItem("chatHistory");if(t)try{const e=JSON.parse(t),n=(new Date).toISOString().slice(0,10);if(e.date===n&&Array.isArray(e.messages))return e.messages;localStorage.removeItem("chatHistory")}catch(t){localStorage.removeItem("chatHistory")}return[]}(),messageIdCounter:0,sid:null,rid:Math.floor(Date.now()/1e3),async connect(){try{console.log("🌐 Step 1: Connecting to XMPP server...");const t=await this.sendRequestWithRetry(`<body xmlns='http://jabber.org/protocol/httpbind'\n               rid='${this.nextRid()}'\n               to='jabber.klavogonki.ru'\n               xml:lang='en'\n               wait='60'\n               hold='1'\n               ver='1.6'\n               xmpp:version='1.0'\n               xmlns:xmpp='urn:xmpp:xbosh'/>`);this.sid=t.match(/sid='(.*?)'/)[1],console.log(`🔑 Step 2: Session ID received: ${this.sid}`),await this.sleep(25),console.log("🔐 Step 3: Authenticating...");const e=this.base64Encode("\0"+I+"\0eb8896e029bd79010ba4f6cbae914a13");if(!(await this.sendRequestWithRetry(`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>${e}</auth>\n        </body>`)).includes("<success"))throw new Error("🚫 Authentication failed");console.log("✅ Step 4: Authentication successful!"),await this.sleep(25),console.log("🔄 Step 5: Restarting stream..."),await this.sendRequestWithRetry(`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'\n               to='jabber.klavogonki.ru'\n               xmpp:restart='true'\n               xmlns:xmpp='urn:xmpp:xbosh'/>`),await this.sleep(25),console.log("📦 Step 6: Binding resource..."),await this.sendRequestWithRetry(`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <iq type='set' id='bind_1' xmlns='jabber:client'>\n            <bind xmlns='urn:ietf:params:xml:ns:xmpp-bind'>\n              <resource>web</resource>\n            </bind>\n          </iq>\n        </body>`),await this.sleep(25),console.log("🔌 Step 7: Establishing session..."),await this.sendRequestWithRetry(`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <iq type='set' id='session_1' xmlns='jabber:client'>\n            <session xmlns='urn:ietf:params:xml:ns:xmpp-session'/>\n          </iq>\n        </body>`),await this.sleep(25),console.log("💬 Step 8: Joining chat room...");const n=await this.sendRequestWithRetry(`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <presence id='pres_1' xmlns='jabber:client' to='general@conference.jabber.klavogonki.ru/${I}'>\n            <x xmlns='http://jabber.org/protocol/muc'/>\n          </presence>\n        </body>`);console.log("📥 Join response:",n),this.userManager.updatePresence(n),await this.sleep(25),console.log("📋 Step 9: Requesting room information..."),await this.sendRequestWithRetry(`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <iq type='get' id='info1' xmlns='jabber:client' to='general@conference.jabber.klavogonki.ru'>\n            <query xmlns='http://jabber.org/protocol/disco#info'/>\n          </iq>\n        </body>`),await this.sleep(S),this.startPresencePolling(),console.log("🚀 Step 10: Connected! Starting presence updates...")}catch(t){console.error(`💥 Error: ${t.message}`)}},sendMessage(t){const e=`msg_${Date.now()}`,n=`\n      <body rid='${this.nextRid()}' sid='${this.sid}' xmlns='http://jabber.org/protocol/httpbind'>\n        <message to='general@conference.jabber.klavogonki.ru'\n                 type='groupchat'\n                 id='${e}'\n                 xmlns='jabber:client'>\n          <body>${t}</body>\n        </message>\n      </body>\n    `;this.sendRequestWithRetry(n).then((t=>this.handleIncomingMessages(t))).catch(console.error)},handleIncomingMessages(t){const e=(new DOMParser).parseFromString(t,"text/xml");e.getElementsByTagName("presence").length>0&&this.userManager.updatePresence(t);const n=e.getElementsByTagName("message");for(const t of n){const e=t.getElementsByTagName("body")[0]?.textContent,n=t.getAttribute("from")?.split("/")[1];e&&n&&n!==I&&(this.messages.push({id:"msg_"+this.messageIdCounter++,from:n,text:e,timestamp:(new Date).toISOString()}),this.updateChatUI())}},updateChatUI(){const t=document.getElementById("messages-panel");t.innerHTML=this.messages.map((t=>{return`\n      <div class="message ${t.from===I?"sent":""}">\n        <div class="message-info">\n          ${t.from} • ${new Date(t.timestamp).toLocaleTimeString()}\n        </div>\n        <div class="message-text">${e=t.text,e.replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,'<a href="$1" target="_blank">$1</a>').replace(/:(\w+):/g,((t,e)=>`<img src="https://klavogonki.ru/img/smilies/${e}.gif" alt="${e}" />`))}</div>\n      </div>\n    `;var e})).join(""),t.scrollTop=t.scrollHeight,function(t){const e=(new Date).toISOString().slice(0,10),n=t.slice(-20);localStorage.setItem("chatHistory",JSON.stringify({date:e,messages:n}))}(this.messages)},base64Encode(t){const e=(new TextEncoder).encode(t);return btoa(String.fromCharCode(...e))},nextRid(){return this.rid++,this.rid},async sendRequest(t){const e=await fetch($,{method:"POST",headers:{"Content-Type":"text/xml; charset=UTF-8","User-Agent":"Mozilla/5.0"},body:t});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.text()},async sendRequestWithRetry(t,e=5){let n;for(let o=1;o<=e;o++)try{return await this.sendRequest(t)}catch(t){if(n=t,!t.message.includes("429"))throw t;{const t=200*Math.pow(2,o);console.log(`⏱️ Rate limited (attempt ${o}/${e}). Waiting ${t}ms...`),await this.sleep(t)}}throw new Error(`Max retries reached. Last error: ${n.message}`)},startPresencePolling(){setInterval((async()=>{const t=await this.sendRequestWithRetry(`<body rid='${this.nextRid()}' sid='${this.sid}' xmlns='http://jabber.org/protocol/httpbind'/>`);this.handleIncomingMessages(t)}),5e3)},sleep:async t=>new Promise((e=>setTimeout(e,t)))};function Q(){const t=document.getElementById("chat-container"),e=document.querySelector(".chat-toggle-button");if(!t)return;if((JSON.parse(localStorage.getItem("chatState"))||{}).floating||!1)t.style.opacity="0"===t.style.opacity?"1":"0",setTimeout((()=>{t.style.display="0"===t.style.opacity?"none":"flex",e.innerHTML="none"===t.style.display?r:a}),300);else{t.classList.toggle("visible-chat"),t.classList.toggle("hidden-chat");const n=t.classList.contains("visible-chat");e.innerHTML=n?a:r}}!function(){!function(){const t=document.createElement("div");t.id="chat-container",["top","left","right"].forEach((e=>{const n=document.createElement("div");n.className=`resize-handle ${e}`,t.appendChild(n)}));const e=document.createElement("div");e.className="chat-wrapper";const n=document.createElement("div");n.className="chat-content";const o=document.createElement("div");o.id="messages-panel",o.className="messages-panel";const r=document.createElement("div");r.className="input-container";const s=document.createElement("input");s.type="text",s.id="message-input",s.placeholder="Type your message...";const c=document.createElement("button");c.id="send-button",c.className="filled-button send-button",c.innerHTML=i,r.appendChild(s),r.appendChild(c),n.appendChild(o),n.appendChild(r);const l=document.createElement("div");l.className="user-list-container";const d=document.createElement("div");d.id="user-list",l.appendChild(d),e.appendChild(n),e.appendChild(l),t.appendChild(e);const m=document.createElement("button");m.className="filled-button header-button chat-toggle-button",m.innerHTML=a,m.addEventListener("click",Q),t.appendChild(m);const p=document.createElement("div");p.className="chat-drag-area",p.addEventListener("dblclick",Q),t.appendChild(p),document.body.appendChild(t),j()}(),function(){const t=document.getElementById("chat-container"),e=document.getElementById("chat-close-btn"),n=document.getElementById("chat-header");t&&(t.classList.add("visible-chat"),document.addEventListener("keydown",(t=>{t.ctrlKey&&"Space"===t.code&&Q()})),e?.addEventListener("click",Q),n?.addEventListener("dblclick",Q))}(),V.userManager=new X,V.updateChatUI();const t=document.getElementById("message-input"),e=document.getElementById("send-button");e.addEventListener("click",(()=>{const e=t.value.trim();e&&(V.messages.push({id:"msg_"+V.messageIdCounter++,from:I,text:e,timestamp:(new Date).toISOString()}),V.updateChatUI(),V.sendMessage(e),t.value="")})),t.addEventListener("keypress",(t=>{"Enter"===t.key&&e.click()})),V.connect()}(),window.addEventListener("resize",(()=>{j(),N()}))})();