// ==UserScript==
// @name         KG_Chat_Application
// @namespace    klavogonki
// @version      1.0.0
// @description  Enhance the chat abilities
// @author       Patcher
// @match        *://klavogonki.ru/*
// @exclude      https://klavogonki.ru/g/?gmid=*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=klavogonki.ru
// @grant        none
// ==/UserScript==

(()=>{"use strict";var t={56:(t,e,n)=>{t.exports=function(t){var e=n.nc;e&&t.setAttribute("nonce",e)}},72:t=>{var e=[];function n(t){for(var n=-1,i=0;i<e.length;i++)if(e[i].identifier===t){n=i;break}return n}function i(t,i){for(var o={},r=[],s=0;s<t.length;s++){var c=t[s],l=i.base?c[0]+i.base:c[0],d=o[l]||0,p="".concat(l," ").concat(d);o[l]=d+1;var m=n(p),h={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==m)e[m].references++,e[m].updater(h);else{var u=a(h,i);i.byIndex=s,e.splice(s,0,{identifier:p,updater:u,references:1})}r.push(p)}return r}function a(t,e){var n=e.domAPI(e);n.update(t);return function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;n.update(t=e)}else n.remove()}}t.exports=function(t,a){var o=i(t=t||[],a=a||{});return function(t){t=t||[];for(var r=0;r<o.length;r++){var s=n(o[r]);e[s].references--}for(var c=i(t,a),l=0;l<o.length;l++){var d=n(o[l]);0===e[d].references&&(e[d].updater(),e.splice(d,1))}o=c}}},113:t=>{t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}},208:(t,e,n)=>{n.d(e,{A:()=>s});var i=n(601),a=n.n(i),o=n(314),r=n.n(o)()(a());r.push([t.id,":root {\n  --border-radius: 0.2em;\n  --min-chat-width: 420px;\n  --min-chat-height: 200px;\n  --user-list-width: fit-content;\n}\n\n/* Main chat container */\n#app-chat-container {\n  border-radius: 0.4em 0.4em 0 0 !important;\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  height: 300px;\n  background: #1e1e1e !important;\n  border: 1px solid #333 !important;\n  display: flex;\n  font-family: sans-serif;\n  color: burlywood !important;\n  z-index: 999;\n  min-width: var(--min-chat-width) !important;\n  min-height: var(--min-chat-height) !important;\n  box-sizing: border-box;\n  max-width: 100vw;\n  overflow: hidden;\n  transition:\n    opacity 0.3s ease,\n    transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n}\n\n/* Font size control */\n#app-chat-container .font-size-control {\n  position: absolute !important;\n  top: 0 !important;\n  left: 0 !important;\n  display: flex !important;\n  align-items: center !important;\n  justify-content: center !important;\n  height: 25px !important;\n  padding: 0 10px !important;\n  gap: 5px !important;\n  z-index: 6 !important;\n}\n\n#app-chat-container .font-size-label {\n  color: burlywood !important;\n  cursor: default !important;\n  user-select: none !important;\n}\n\n#app-chat-container .font-size-label.small {\n  font-size: 0.8em !important;\n}\n\n#app-chat-container .font-size-label.large {\n  font-size: 1.2em !important;\n}\n\n#app-chat-container .font-size-slider {\n  width: 80px !important;\n  height: 4px !important;\n  -webkit-appearance: none !important;\n  appearance: none !important;\n  background: #333 !important;\n  outline: none !important;\n  border-radius: 2px !important;\n  transition: opacity 0.2s !important;\n}\n\n#app-chat-container .font-size-slider::-webkit-slider-thumb {\n  -webkit-appearance: none !important;\n  appearance: none !important;\n  width: 10px !important;\n  height: 10px !important;\n  border-radius: 50% !important;\n  background: burlywood !important;\n  cursor: pointer !important;\n}\n\n#app-chat-container .font-size-slider::-moz-range-thumb {\n  width: 10px !important;\n  height: 10px !important;\n  border-radius: 50% !important;\n  background: burlywood !important;\n  cursor: pointer !important;\n  border: none !important;\n}\n\n/* Ensure time and username elements maintain their relative sizes */\n#app-chat-container .message-info .time {\n  font-size: 0.9em !important;\n}\n\n#app-chat-container .username {\n  font-size: 1em !important;\n}\n\n/* Chat container maximized state */\n#app-chat-container.maximized {\n  position: fixed;\n  z-index: 1010;\n}\n\n/* Responsive: hide user list on small screens */\n@media (max-width: 780px) {\n  #app-chat-container .user-list-container {\n    display: none !important;\n  }\n\n  #app-chat-container .chat-wrapper {\n    width: 100% !important;\n    border-right: none !important;\n  }\n}\n\n@media (max-width: 550px) {\n  #app-chat-container .message {\n    flex-direction: column !important;\n    margin-bottom: 1em !important;\n  }\n}\n\n#app-chat-container:not(.visible-chat):not(.hidden-chat):not(.maximized):not(.floating-chat) {\n  display: none;\n  opacity: 0;\n}\n\n#app-chat-container.visible-chat {\n  transform: translateY(0) !important;\n}\n\n#app-chat-container.hidden-chat {\n  opacity: 1;\n  transform: translateY(calc(100% - 25px)) !important;\n}\n\n/* Resize handles */\n#app-chat-container .resize-handle {\n  position: absolute !important;\n  background: transparent !important;\n  z-index: 1000 !important;\n}\n\n#app-chat-container .resize-handle.top {\n  top: -3px !important;\n  left: 0 !important;\n  right: 0 !important;\n  height: 6px !important;\n  cursor: ns-resize !important;\n}\n\n#app-chat-container .resize-handle.left {\n  left: -3px !important;\n  top: 0 !important;\n  bottom: 0 !important;\n  width: 6px !important;\n  cursor: ew-resize !important;\n}\n\n#app-chat-container .resize-handle.right {\n  right: -3px !important;\n  top: 0 !important;\n  bottom: 0 !important;\n  width: 6px !important;\n  cursor: ew-resize !important;\n}\n\n/* Chat wrapper: two-column layout */\n#app-chat-container .chat-wrapper {\n  display: flex !important;\n  flex-direction: row !important;\n  flex: 1 !important;\n  min-width: var(--min-chat-width) !important;\n  overflow: hidden !important;\n}\n\n/* Left column: messages & input */\n#app-chat-container .chat-content {\n  margin-top: 25px !important;\n  background: #1e1e1e !important;\n  display: flex !important;\n  flex-direction: column !important;\n  flex: 1 !important;\n  overflow: hidden !important;\n}\n\n/* Messages panel takes most of the space */\n#app-chat-container .messages-panel {\n  flex: 1 !important;\n  overflow-y: auto !important;\n  overflow-x: hidden !important;\n  padding: 1em !important;\n  display: flex !important;\n  flex-direction: column !important;\n  gap: 0.6em !important;\n}\n\n/* Input container at bottom */\n#app-chat-container .input-container {\n  display: flex !important;\n  padding: 1em !important;\n  gap: 0.5em !important;\n  border-top: 1px solid #333 !important;\n}\n\n#app-chat-container #message-input {\n  flex: 1 !important;\n  background: #2a2a2a !important;\n  color: burlywood !important;\n  padding: 0.5em !important;\n  border-radius: var(--border-radius) !important;\n  min-width: 0 !important;\n  border: none !important;\n}\n\n/* Right column: user list container */\n#app-chat-container .user-list-container {\n  margin-top: 25px;\n  width: var(--user-list-width) !important;\n  min-width: 180px !important;\n  max-width: var(--user-list-width) !important;\n  overflow-y: auto !important;\n  overflow-x: hidden !important;\n  padding: 1em !important;\n  background: #1e1e1e !important;\n  border-left: 1px solid #333 !important;\n}\n\n.user-item .user-info .username .role {\n  transition: filter 0.3s ease;\n}\n\n.user-item .user-info .username .role.participant {\n  filter: brightness(0.6);\n}\n\n.user-item .user-info .username .role.moderator {\n  filter: brightness(1);\n}\n\n.user-item .user-info .username .role.visitor {\n  filter: brightness(0.8);\n}\n\n/* Header toggle button */\n#app-chat-container .header-button {\n  cursor: pointer !important;\n  position: absolute !important;\n  top: 0 !important;\n  width: 25px !important;\n  height: 25px !important;\n  z-index: 5 !important;\n}\n\n#app-chat-container .filled-button {\n  border: none !important;\n  background-color: transparent !important;\n  transition: all 0.15s ease-out;\n}\n\n#app-chat-container .filled-button:hover {\n  filter: brightness(1.2) !important;\n}\n\n#app-chat-container .chat-toggle-button {\n  right: 0 !important;\n}\n\n/* Maximize button positioning and styling */\n.chat-maximize-button {\n  right: 25px !important;\n}\n\n/* Drag area for floating the chat */\n#app-chat-container .chat-drag-area {\n  border-radius: 0.4em 0.4em 0 0 !important;\n  position: absolute !important;\n  top: 0 !important;\n  left: 0 !important;\n  right: 0 !important;\n  height: 25px !important;\n  cursor: move !important;\n  background-color: rgba(22, 22, 22, 0.8) !important;\n}\n\n/* Specific styling for floating chats */\n#app-chat-container.floating-chat {\n  border-radius: 0.4em !important;\n}\n\n/* Message styles */\n#app-chat-container .message {\n  display: flex;\n  flex-direction: row;\n  padding: 0.08em 0.8em !important;\n  border-radius: var(--border-radius) !important;\n  width: fit-content !important;\n  max-width: 100% !important;\n  word-break: break-word !important;\n}\n\n#app-chat-container .message.system {\n  background-color: #deb88725 !important;\n  border: 1px solid #deb88750 !important;\n}\n\n#app-chat-container .message.sent {\n  background: #293e2985 !important;\n  border: 1px solid #293e29 !important;\n}\n\n#app-chat-container .message-info {\n  white-space: nowrap !important;\n  font-size: 0.9em !important;\n  line-height: 1.5em !important;\n  margin-right: 1em !important;\n}\n\n/* Add to existing style.css content */\n#app-chat-container .message-info .username,\n#app-chat-container .user-info .username {\n  cursor: pointer !important;\n  transition: opacity 0.2s ease !important;\n}\n\n#app-chat-container .message-info .username:hover,\n#app-chat-container .user-info .username:hover {\n  opacity: 0.7 !important;\n}\n\n#app-chat-container .message-info .time {\n  margin-right: 1em !important;\n  font-size: 0.9em !important;\n  color: #666 !important;\n}\n\n/* User list item styles */\n#app-chat-container .user-item {\n  display: flex !important;\n  align-items: center !important;\n  padding: 0.2em !important;\n  margin-bottom: 0.2em !important;\n  border-radius: var(--border-radius) !important;\n  max-width: 100% !important;\n  text-overflow: ellipsis !important;\n}\n\n#app-chat-container .user-avatar {\n  display: flex !important;\n  justify-content: center !important;\n  align-items: center !important;\n  width: 24px !important;\n  height: 24px !important;\n  font-size: 18px !important;\n  border-radius: 0.1em !important;\n  margin-right: 1em !important;\n  text-align: center !important;\n  line-height: 24px !important;\n  flex-shrink: 0 !important;\n}\n\n#app-chat-container .user-avatar.image-avatar {\n  cursor: pointer !important;\n  transform-origin: left !important;\n  transition: transform 0.15s ease-out !important;\n}\n\n#app-chat-container .user-avatar.image-avatar:hover {\n  transform: scale(2) !important;\n}\n\n#app-chat-container .user-avatar.svg-avatar {\n  filter: grayscale(0.5) !important;\n}\n\n#app-chat-container .user-info {\n  flex: 1 !important;\n  min-width: 0 !important;\n  overflow: hidden !important;\n  text-overflow: ellipsis !important;\n  white-space: nowrap !important;\n}\n\n#app-chat-container .user-meta {\n  cursor: default;\n  font-size: 0.8em !important;\n  color: #b0b0b0 !important;\n  overflow: hidden !important;\n  text-overflow: ellipsis !important;\n  white-space: nowrap !important;\n}\n\n#app-chat-container .game-link {\n  color: burlywood !important;\n  text-decoration: none !important;\n  transition: color 0.15s !important;\n}\n\n#app-chat-container .role-moderator {\n  color: #ff7e7e !important;\n}\n\n#app-chat-container .role-participant {\n  color: #7ed4ff !important;\n}\n\n#app-chat-container .role-visitor {\n  color: #b0b0b0 !important;\n}\n\n/* Dimming background style */\n.dimming-element {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background-color: rgba(0, 0, 0, 0.5);\n  z-index: 1010 !important;\n  opacity: 0;\n  transition: opacity 0.3s ease;\n}\n\n/* convertImageLinksToImage */\n.clickable-thumbnail {\n  opacity: 1;\n  transition: opacity 0.15s ease-in-out;\n  border: none;\n  max-width: 150px !important;\n  max-height: 150px !important;\n  cursor: pointer;\n  background-color: transparent;\n  padding: 2px;\n  margin: 6px;\n  overflow-y: auto;\n}\n\n.clickable-thumbnail img {\n  border-radius: var(--border-radius) !important;\n  object-fit: contain;\n  height: 100%;\n  width: 100%;\n}\n\n.clickable-thumbnail:hover {\n  opacity: 0.8;\n}\n\n.scaled-thumbnail {\n  top: 50%;\n  left: 50%;\n  transform-origin: center center;\n  transform: translate(-50%, -50%) scale(1);\n  position: fixed;\n  opacity: 0;\n  z-index: 1015 !important;\n  transform-origin: center center;\n  max-height: 90vh;\n  max-width: 90vw;\n  cursor: pointer;\n  border-radius: 0.6em !important;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.28) !important;\n}\n\n/* convertVideoLinksToPlayer */\n.video-wrapper {\n  display: flex;\n  flex-direction: column;\n}\n\n.video-wrapper .processed-video {\n  margin-bottom: 0.6em !important;\n}\n\n.video-container {\n  border-radius: 0.4em !important;\n  display: flex;\n  border: none;\n  height: 200px !important;\n  width: 356px !important\n}\n",""]);const s=r},314:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var n="",i=void 0!==e[5];return e[4]&&(n+="@supports (".concat(e[4],") {")),e[2]&&(n+="@media ".concat(e[2]," {")),i&&(n+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),n+=t(e),i&&(n+="}"),e[2]&&(n+="}"),e[4]&&(n+="}"),n})).join("")},e.i=function(t,n,i,a,o){"string"==typeof t&&(t=[[null,t,void 0]]);var r={};if(i)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(r[c]=!0)}for(var l=0;l<t.length;l++){var d=[].concat(t[l]);i&&r[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),e.push(d))}},e}},540:t=>{t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},601:t=>{t.exports=function(t){return t[1]}},659:t=>{var e={};t.exports=function(t,n){var i=function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}e[t]=n}return e[t]}(t);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},825:t=>{t.exports=function(t){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=t.insertStyleElement(t);return{update:function(n){!function(t,e,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var a=void 0!==n.layer;a&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,a&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var o=n.sourceMap;o&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),e.styleTagTransform(i,t,e.options)}(e,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}}},e={};function n(i){var a=e[i];if(void 0!==a)return a.exports;var o=e[i]={id:i,exports:{}};return t[i](o,o.exports,n),o.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.nc=void 0;var i=n(72),a=n.n(i),o=n(825),r=n.n(o),s=n(659),c=n.n(s),l=n(56),d=n.n(l),p=n(540),m=n.n(p),h=n(113),u=n.n(h),g=n(208),f={};f.styleTagTransform=u(),f.setAttributes=d(),f.insert=c().bind(null,"head"),f.domAPI=r(),f.insertStyleElement=m();a()(g.A,f);g.A&&g.A.locals&&g.A.locals;const y="https://klavogonki.ru",b=`${y}/xmpp-httpbind/`,x={get username(){const t=localStorage.getItem("klavoauth");return t?JSON.parse(t).username:""},get password(){const t=localStorage.getItem("klavoauth");return t?JSON.parse(t).password:""}},v=["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😏","😐","😑","😒","😓","😔","😕","😖","😗","😘","😙","😚","😜","😝","😛","🤑","🤗","🤔","🤐","🤨","😣","😥","😮","🤯","😳","😱","😨","😰","😢","🤪","😵","😲","🤤","😷","🤒","🤕","🤢","🤧","😇","🥳","🥺","😬","😴","😌","🤥","🥴","🥵","🥶","🤧","🤭","🤫","😠","😡","😳","😞","😟","😕","🐱","😺","😸","😹","😻","😼","😽","🙀","😿","😾","🐶","🐭","🐹","🐰","🦊","🐻","🐼","🐨","🐯","🦁","🐮","🐷","🐸","🐵","🙈","🙉","🙊","🐔","🦄"];let w={bigImageEvents:{}};const E=["klavogonki.ru","youtube.com","youtu.be","imgur.com","pikabu.ru","userapi.com","ibb.co","yaplakal.com","freepik.com"];class L{constructor({username:t,password:e,bindUrl:n,delay:i=1e3}){this.username=t,this.password=e,this.bindUrl=n,this.delay=i,this.sid=null,this.rid=Math.floor(Date.now()/1e3)}nextRid(){return++this.rid}async sendRequest(t){const e=await fetch(this.bindUrl,{method:"POST",headers:{"Content-Type":"text/xml; charset=UTF-8","User-Agent":"Mozilla/5.0"},body:t});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.text()}async sendRequestWithRetry(t,e=5){let n,i=this.delay;for(let a=1;a<=e;a++)try{return await this.sendRequest(t)}catch(t){if(n=t,!t.message.includes("429"))throw t;{const t=i*Math.pow(2,a);console.log(`⏱️ Rate limited (attempt ${a}/${e}). Waiting ${t}ms...`),await this.sleep(t)}}throw new Error(`Max retries reached. Last error: ${n.message}`)}sleep(t){return new Promise((e=>setTimeout(e,t)))}base64Encode(t){const e=(new TextEncoder).encode(t);return btoa(String.fromCharCode(...e))}async connect(){console.log("🌐 Step 1: Connecting to XMPP server...");const t=`<body xmlns='http://jabber.org/protocol/httpbind'\n               rid='${this.nextRid()}'\n               to='jabber.klavogonki.ru'\n               xml:lang='en'\n               wait='60'\n               hold='1'\n               ver='1.6'\n               xmpp:version='1.0'\n               xmlns:xmpp='urn:xmpp:xbosh'/>`,e=await this.sendRequestWithRetry(t);this.sid=e.match(/sid=['"]([^'"]+)['"]/)[1],console.log(`🔑 Step 2: Session ID received: ${this.sid}`),await this.sleep(this.delay/8),console.log("🔐 Step 3: Authenticating...");const n=this.base64Encode("\0"+this.username+"\0"+this.password),i=`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>${n}</auth>\n        </body>`;if(!(await this.sendRequestWithRetry(i)).includes("<success"))throw new Error("❌ Authentication failed");console.log("✅ Step 4: Authentication successful!"),await this.sleep(this.delay/8),console.log("🔄 Step 5: Restarting stream...");const a=`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'\n               to='jabber.klavogonki.ru'\n               xmpp:restart='true'\n               xmlns:xmpp='urn:xmpp:xbosh'/>`;await this.sendRequestWithRetry(a),await this.sleep(this.delay/8),console.log("📦 Step 6: Binding resource...");const o=`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <iq type='set' id='bind_1' xmlns='jabber:client'>\n            <bind xmlns='urn:ietf:params:xml:ns:xmpp-bind'>\n              <resource>web</resource>\n            </bind>\n          </iq>\n        </body>`;await this.sendRequestWithRetry(o),await this.sleep(this.delay/8),console.log("🔌 Step 7: Establishing session...");const r=`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <iq type='set' id='session_1' xmlns='jabber:client'>\n            <session xmlns='urn:ietf:params:xml:ns:xmpp-session'/>\n          </iq>\n        </body>`;return await this.sendRequestWithRetry(r),await this.sleep(this.delay/8),{sid:this.sid,rid:this.rid}}}const k=["jpg","jpeg","png","gif","webp"],S="📸",$="🖥️",I="💀️️",M=.2,C=10,z=.1;let T=0,A=!1,H=[],N=null;const R=t=>{const e=(t=>{try{return t.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||""}catch(t){return console.error("Error extracting extension:",t.message),""}})(t);return{allowed:k.includes(e),extension:e}},B=(t,e)=>{const n=document.createElement("img");n.src=t,n.classList.add("scaled-thumbnail"),document.body.appendChild(n),T=e;let i=1,a=!1,o=0,r=0,s=0,c=0;let l=document.querySelector(".dimming-element");l||(l=document.createElement("div"),l.classList.add("dimming-element"),document.body.appendChild(l));const d=t=>{mt(t,"hide","0"),!document.querySelector(".popup-panel")&&l&&mt(l,"hide","0"),pt()};return w.bigImageEvents.click=t=>{n.contains(t.target)||(n.remove(),pt())},w.bigImageEvents.keydown=t=>{"Escape"===t.code||"Space"===t.code?(t.preventDefault(),d(n)):"ArrowLeft"===t.code?q(-1):"ArrowRight"===t.code&&q(1)},w.bigImageEvents.wheel=t=>{const e=t.deltaY<0?1:-1;i+=e*z*i,i=Math.max(M,Math.min(i,C)),n.style.transform=`translate(-50%, -50%) translate(${s}px, ${c}px) scale(${i})`},w.bigImageEvents.mousemove=t=>{if(a){if(t.ctrlKey){const e=t.clientY-r,n=e<0?1:-1,a=Math.abs(e)*z*.05;i+=n*a*i,i=Math.max(M,Math.min(i,C))}else{const e=(t.clientX-o)/i*5,n=(t.clientY-r)/i*5;s+=e,c+=n}n.style.transform=`translate(-50%, -50%) translate(${s}px, ${c}px) scale(${i})`,o=t.clientX,r=t.clientY}},w.bigImageEvents.mousedown=t=>{const{button:e,clientX:i,clientY:s,target:c,ctrlKey:l}=t;(0!==e&&2!==e||c===n)&&(0===e?q(-1):2===e?(t.preventDefault(),l?(navigator.clipboard.writeText(c.src).catch(console.error),d(n)):q(1)):1===e&&(a=!0,o=i,r=s,t.preventDefault()))},w.bigImageEvents.mouseup=t=>{1===t.button&&(a=!1)},w.bigImageEvents.contextmenu=t=>t.preventDefault(),Object.entries(w.bigImageEvents).forEach((([t,e])=>{document.addEventListener(t,e)})),mt(l,"show","1"),l.addEventListener("click",(()=>{d(n)})),n},q=t=>{const e=T+t;e>=0&&e<H.length&&!A&&(A=!0,N&&(N.src=H[e].imgSrc),setTimeout((()=>A=!1),50),T=e)};function P(t){const e=document.getElementById("messages-panel");if(!e)return;const n=e.querySelectorAll("a:not(.skipped):not(.processed-image)");function i(t,n){const i=document.createElement("div");i.classList.add("clickable-thumbnail"),i.dataset.sourceLink=t.href;const a=document.createElement("img");a.src=t.href,a.onload=()=>{i.appendChild(a),t.parentNode.insertBefore(i,t.nextSibling)},a.onerror=()=>{console.error("Failed to load image:",t.href),t.classList.add("skipped")},n?t.querySelector(".clickable-thumbnail")||t.addEventListener("click",(e=>{t.querySelector(".clickable-thumbnail")||(i.appendChild(a),t.parentNode.insertBefore(i,t.nextSibling))})):(i.appendChild(a),t.parentNode.insertBefore(i,t.nextSibling)),i.addEventListener("click",(n=>{n.stopPropagation(),H=[],e.querySelectorAll(".clickable-thumbnail").forEach(((t,e)=>{const n=t.querySelector("img");n&&t.dataset.sourceLink&&H.push({link:t.dataset.sourceLink,imgSrc:n.src,index:e})}));const i=H.findIndex((e=>e.link===t.href||e.imgSrc===a.src));N=B(a.src,i>=0?i:0),mt(N,"show","1");const o=document.querySelector(".dimming-element");o&&mt(o,"show","1")}))}n.length&&n.forEach((t=>{if(!t.href||!t.href.startsWith("http"))return;const{allowed:e,extension:n}=R(t.href);if(!e)return;t.classList.add("media");const{isTrusted:a,domain:o}=ht(t.href);t.title=ut(t.href)?gt(t.href):t.href,a?function(t,e,n){t.textContent=`${S} Image (${e.toUpperCase()}) ${$} Hostname (${n})`,t.classList.add("processed-image"),i(t,!1)}(t,n,o):function(t,e,n){t.classList.add("skipped"),t.textContent=`${S} Image (${e.toUpperCase()}) ${$} Hostname (${n}) ${I} Untrusted`,t.addEventListener("click",(e=>{t.classList.contains("processed-image")||(e.preventDefault(),t.classList.remove("skipped"),t.classList.add("processed-image"),i(t,!0))}))}(t,n,o)}))}const j="🎥",U="🖥️",F="💀️️",D=["mp4","webm","ogg","mov","avi"];function W(t){const e=document.getElementById("messages-panel");if(!e)return;const n=e.querySelectorAll("a:not(.skipped):not(.processed-video)");function i(t,e,n,i){const{youtubeMatch:a,videoType:o,videoId:r}=i,s=(t=>{const e=t.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||"";return{allowed:D.includes(e),extension:e}})(e);if(!a&&!s.allowed)return;t.classList.add("processed-video");const c=document.createElement("div");c.classList.add("video-wrapper");const l=document.createElement(a?"iframe":"video");l.classList.add("video-container"),t.textContent=`${j} ${o} ${U} Hostname (${n})`,a?(l.src=`https://www.youtube.com/embed/${r}`,l.allowFullscreen=!0):(l.src=e,l.controls=!0),t.title=ut(e)?gt(e):e,t.style.display="inline-flex",t.parentNode.insertBefore(c,t),c.append(t,l)}n.length&&n.forEach((t=>{const e=t.href;if(!e)return;const n=function(t){const e=t.match(/(?:shorts\/|live\/|watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);if(e){return{youtubeMatch:!0,videoId:e[1],videoType:t.includes("shorts/")?"Shorts":t.includes("live/")?"Live":t.includes("watch?v=")?"Watch":t.includes("youtu.be/")?"Share":"YouTube"}}const n=t.split(".").pop().toLowerCase();if(D.includes(n))return{youtubeMatch:!1,videoType:`Video (${n.toUpperCase()})`};return!1}(e);if(!n)return;t.classList.add("media");const{isTrusted:a,domain:o}=ht(e);if(!a)return t.classList.add("skipped"),t.textContent=`${j} ${n.videoType} ${U} Hostname (${o}) ${F} Untrusted`,void t.addEventListener("click",(a=>{t.classList.contains("processed-video")||(a.preventDefault(),t.classList.remove("skipped"),i(t,e,o,n))}));i(t,e,o,n)}))}const O="http://www.w3.org/2000/svg",_="#82B32A",V="#B34A2A",J=`\n  <svg xmlns="${O}" \n      width="24" \n      height="24" \n      viewBox="0 0 250 250">\n    <path fill="#096AD9" d="M22.32 98.04l-19.04 -87.15c-0.75,-3.46 0.48,-6.84 3.29,-9 2.81,-2.17 6.39,-2.49 9.55,-0.87l225.95 116.02c3.07,1.57 4.87,4.52 4.87,7.96 0,3.44 -1.8,6.39 -4.87,7.96l-225.95 116.02c-3.16,1.62 -6.74,1.3 -9.55,-0.87 -2.81,-2.16 -4.04,-5.54 -3.29,-9l19.04 -87.15c0.79,-3.62 3.53,-6.26 7.18,-6.91l102.6 -18.19c0.91,-0.16 1.56,-0.94 1.56,-1.86 0,-0.92 -0.65,-1.7 -1.56,-1.86l-102.6 -18.19c-3.65,-0.65 -6.39,-3.29 -7.18,-6.91z"/>\n  </svg>\n`,Y=`\n  <svg xmlns="${O}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250" \n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n      <path fill="${_}" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm45.71 70.24l32.67 32.67 32.67 -32.67c2.73,-2.73 7.18,-2.73 9.91,0l12.18 12.18c2.73,2.73 2.73,7.18 0,9.91l-32.67 32.67 32.67 32.66c2.73,2.74 2.73,7.19 0,9.92l-12.18 12.18c-2.73,2.73 -7.18,2.73 -9.91,0l-32.67 -32.67 -32.67 32.67c-2.73,2.73 -7.18,2.73 -9.91,0l-12.18 -12.18c-2.73,-2.73 -2.73,-7.18 0,-9.92l32.67 -32.66 -32.67 -32.67c-2.73,-2.73 -2.73,-7.18 0,-9.91l12.18 -12.18c2.73,-2.73 7.18,-2.73 9.91,0z"/>\n  </svg>\n`,X=`\n  <svg xmlns="${O}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250" \n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n      <path fill="${V}" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm15.5 135.79l57.92 -57.93c2.73,-2.73 7.19,-2.72 9.92,0.01l57.92 57.92c2.73,2.73 2.73,7.18 0,9.91l-12.18 12.18c-2.73,2.73 -7.18,2.73 -9.92,0l-35.82 -35.83c-2.73,-2.73 -7.19,-2.73 -9.92,0l-35.82 35.83c-2.74,2.73 -7.19,2.73 -9.92,0l-12.18 -12.18c-2.73,-2.73 -2.73,-7.18 0,-9.91z"/>\n  </svg>\n`,K=`\n  <svg xmlns="${O}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250"\n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n    <path fill="${_}" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm109.99 181.69l-75.07 0c-7.3,0 -13.23,-5.92 -13.23,-13.22l0 -75.08c0,-2.35 1.92,-4.28 4.28,-4.28l17.9 0c2.35,0 4.27,1.93 4.27,4.28l0 32.81c0,1.77 1.01,3.28 2.64,3.96 1.63,0.67 3.42,0.33 4.66,-0.93l59.68 -59.68c1.67,-1.65 4.38,-1.65 6.05,0l12.66 12.66c1.66,1.67 1.66,4.38 0,6.05l-59.68 59.68c-1.26,1.24 -1.6,3.03 -0.93,4.66 0.68,1.63 2.19,2.64 3.96,2.64l32.81 0c2.35,0 4.28,1.92 4.28,4.28l0 17.9c0,2.36 -1.93,4.28 -4.28,4.28z"/>\n  </svg>\n`,Q=`\n  <svg xmlns="${O}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250"\n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n    <path fill="${V}" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm46.77 68.31l75.07 0c7.3,0 13.23,5.92 13.23,13.22l0 75.08c0,2.35 -1.92,4.28 -4.28,4.28l-17.9 0c-2.35,0 -4.27,-1.93 -4.27,-4.28l0 -32.81c0,-1.77 -1.01,-3.28 -2.64,-3.96 -1.63,-0.67 -3.42,-0.33 -4.66,0.93l-59.68 59.68c-1.67,1.65 -4.38,1.65 -6.05,0l-12.66 -12.66c-1.66,-1.67 -1.66,-4.38 0,-6.05l59.68 -59.68c1.26,-1.24 1.6,-3.03 0.93,-4.66 -0.68,-1.63 -2.19,-2.64 -3.96,-2.64l-32.81 0c-2.35,0 -4.28,-1.92 -4.28,-4.27l0 -17.9c0,-2.36 1.93,-4.28 4.28,-4.28z"/>\n  </svg>\n`;function Z(t){return{hueMap:{},hueStep:t.hueStep||30,maxHue:t.maxHue||360,saturation:t.saturation||"80%",lightness:t.lightness||"50%",getColor(t){let e=this.hueMap[t];if(!e){const n=this.maxHue/this.hueStep;e=Math.floor(Math.random()*n)*this.hueStep,this.hueMap[t]=e}return`hsl(${e}, ${this.saturation}, ${this.lightness})`}}}const G=Z({maxHue:210,hueStep:30,saturation:"80%",lightness:"50%"}),tt=Z({maxHue:210,hueStep:30,saturation:"80%",lightness:"50%"});let et=null;function nt(){let t;do{t=v[Math.floor(Math.random()*v.length)]}while(t===et);return et=t,t}function it(){const t=document.querySelector("#app-chat-container .chat-wrapper");if(!t)return;const e=document.querySelector("#app-chat-container"),n=t.offsetWidth<=780,i=e.classList.contains("maximized"),a=document.querySelector("#app-chat-container .user-list-container");a&&(a.style.display=n&&!i?"none":""),document.querySelectorAll("#app-chat-container .message").forEach((t=>{t.style.flexDirection=n&&!i?"column":"row",t.style.marginBottom=n&&!i?"1em":"0"}))}function at(){const t=document.getElementById("app-chat-container"),e=document.querySelector(".chat-toggle-button");if(!t||!e)return;const n=ot(),i=window.innerWidth,a=window.innerHeight,o=getComputedStyle(document.documentElement),r=parseInt(o.getPropertyValue("--min-chat-width"))||250,s=parseInt(o.getPropertyValue("--min-chat-height"))||200;t.style.width=Math.min(i,Math.max(r,n.width))+"px",t.style.height=Math.min(a,Math.max(s,n.height))+"px",t.style.left=lt(n.left,0,i-t.offsetWidth)+"px",n.floating?(t.style.top=lt(n.top,0,a-t.offsetHeight)+"px",t.style.bottom="",t.classList.add("floating-chat"),t.style.display=n.isVisible?"flex":"none",t.style.opacity=n.isVisible?"1":"0",e.innerHTML=n.isVisible?Y:X):(t.style.bottom="0",t.style.top="",t.classList.remove("floating-chat"),t.classList.remove("visible-chat","hidden-chat"),t.classList.add(n.isVisible?"visible-chat":"hidden-chat"),e.innerHTML=n.isVisible?Y:X),it()}function ot(){const t=localStorage.getItem("chatState"),e={height:300,width:Math.min(window.innerWidth,600),left:0,floating:!1,top:window.innerHeight-300,isVisible:!0,fontSizeMultiplier:1};return t?{...e,...JSON.parse(t)}:e}function rt(t){const e=document.getElementById("app-chat-container");if(!e)return;e.style.fontSize=`${t}em`;ct({...ot(),fontSizeMultiplier:t})}function st(){rt(ot().fontSizeMultiplier)}function ct(t){localStorage.setItem("chatState",JSON.stringify(t))}function lt(t,e,n){return Math.min(Math.max(t,e),n)}function dt(t){return"string"!=typeof t?t:t.replace(/^\d+#/,"")}function pt(){Object.entries(w.bigImageEvents).forEach((([t,e])=>{document.removeEventListener(t,e)}))}function mt(t,e,n){t&&(t.offsetHeight,t.style.transition="opacity 0.3s",t.style.opacity="show"===e?n:"0","hide"===e&&t.addEventListener("transitionend",(()=>{"0"===t.style.opacity&&t.remove()}),{once:!0}))}const ht=t=>{try{const{hostname:e}=new URL(t),n=e.toLowerCase().split(".").slice(-2).join(".");return{isTrusted:E.includes(n),domain:n}}catch(e){return console.error("Error in isTrustedDomain:",e.message),{isTrusted:!1,domain:t}}};function ut(t){return/^https?:\/\//.test(t)&&/%[0-9A-Fa-f]{2}/.test(t)}function gt(t){const[e]=t.split("#");return decodeURIComponent(e).replace(/ /g,"_")}function ft(){const t=document.getElementById("messages-panel");if(!t)return;const e=localStorage.getItem("mentionKeywords");if(!e)return;let n;try{if(n=JSON.parse(e),!Array.isArray(n))return}catch(t){return}const i=new WeakSet;t.querySelectorAll(".message-text").forEach((t=>{const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:t=>{if(i.has(t))return NodeFilter.FILTER_SKIP;return t.parentElement.closest(".mention, .time, .username")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}}),a=[];let o;for(;o=e.nextNode();)a.push(o);a.forEach((t=>{i.has(t)||(!function(t,e){const n=/(@?[\wа-яА-ЯёЁ'-]+)|[\s]+|[^@\s\wа-яА-ЯёЁ'-]+/gu,i=t.textContent.match(n)||[],a=document.createDocumentFragment();i.forEach((t=>{if(e.some((e=>0===e.localeCompare(t,void 0,{sensitivity:"accent"})))){const e=document.createElement("span");e.className="mention",t.split("").forEach((t=>{const n=document.createElement("span");n.style.color=tt.getColor(t),n.textContent=t,e.appendChild(n)})),a.appendChild(e)}else a.appendChild(document.createTextNode(t))})),t.parentNode.replaceChild(a,t)}(t,n),i.add(t))}))}))}let yt=!0;const bt=300;function xt(){const t=document.getElementById("messages-panel");if(t)if(yt)t.scrollTop=t.scrollHeight,yt=!1;else{t.scrollHeight-t.scrollTop-t.clientHeight<=bt&&(t.scrollTop=t.scrollHeight)}}function vt(){const t=document.getElementById("app-chat-container"),e=document.getElementById("message-input");return!(!e||!t||"none"===t.style.display)&&(e.focus(),!0)}class wt{constructor(t="user-list"){this.container=document.getElementById(t),this.activeUsers=new Map,this.isFirstLoad=!0,this.roleIcons={visitor:"🐥",participant:"🗿",moderator:"⚔️️"},this.rolePriority={moderator:1,participant:2,visitor:3},this.setupEventListeners()}setupEventListeners(){this.container.addEventListener("click",(t=>{if(t.target.classList.contains("username-clickable")){const e=t.target.getAttribute("data-user-id");if(e){const t=e.split("/")[1].split("#")[0];window.location.href=`https://klavogonki.ru/u/#/${t}/`}}if(t.target.closest(".game-indicator")){const e=t.target.closest(".game-indicator").getAttribute("data-game-id");e&&(t.stopPropagation(),window.location.href=`https://klavogonki.ru/g/?gmid=${e}`)}}))}updatePresence(t){const e=(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("presence");if(t.includes('<presence id="pres_1"'))return console.log("🔄 Initial room join detected, requesting full roster"),void this.requestFullRoster();let n=!1;const i=[],a=[];for(let t=0;t<e.length;t++){const o=e[t],r=o.getAttribute("from");if("unavailable"===o.getAttribute("type")){this.activeUsers.has(r)&&(console.log(`🚪 User left: ${this.activeUsers.get(r).login||r}`),this.activeUsers.delete(r),n=!0);continue}let s=null;const c=o.getElementsByTagName("x");for(let t=0;t<c.length;t++)if("klavogonki:userdata"===c[t].namespaceURI){s=c[t];break}if(!s){console.log(`⚠️ No klavogonki:userdata found for presence from: ${r}`);continue}const l=s.getElementsByTagName("user")[0];if(!l){console.log(`⚠️ No user node found in klavogonki:userdata for presence from: ${r}`);continue}const d=dt(l.getElementsByTagName("login")[0]?.textContent||"Anonymous"),p=l.getElementsByTagName("avatar")[0]?.textContent,m=l.getElementsByTagName("background")[0]?.textContent||"#777",h=s.getElementsByTagName("game_id")[0]?.textContent||null,u=l.getElementsByTagName("moderator")[0],g=u&&"1"===u.textContent,f=o.getElementsByTagName("item")[0];let y=f?.getAttribute("role")||"participant";g&&(y="moderator");const b={jid:r,login:d,avatar:p,color:m,role:y,usernameColor:G.getColor(d),gameId:h},x=this.activeUsers.get(r);x?JSON.stringify(x)!==JSON.stringify(b)&&(console.log(`👤 User updated: ${d}`),this.activeUsers.set(r,b),n=!0,a.push(r)):(console.log(`👤 User joined: ${d}`),this.activeUsers.set(r,b),n=!0,i.push(r))}n&&(console.log(`📋 Current active users: ${this.activeUsers.size}`),this.updateUI(i,a))}updateUI(t=[],e=[]){console.log(`🖥️ Updating UI with ${this.activeUsers.size} users`);const n=new Map;this.container.querySelectorAll(".user-item").forEach((t=>{n.set(t.getAttribute("data-jid"),t)}));const i=Array.from(this.activeUsers.values()).sort(((t,e)=>{const n=this.rolePriority[t.role]-this.rolePriority[e.role];return 0!==n?n:t.login.localeCompare(e.login)})),a=document.createDocumentFragment();i.forEach((t=>{let e=n.get(t.jid);if(e){n.delete(t.jid);const i=e.querySelector(".role"),a=this.roleIcons[t.role]||"👤";i&&(i.textContent!==a&&(i.textContent=a),i.classList.contains(t.role)||(i.className=`role ${t.role}`))}else{e=document.createElement("div"),e.classList.add("user-item"),e.setAttribute("data-jid",t.jid);const n=dt(t.login),i=this.roleIcons[t.role]||"👤";let a="";if(t.avatar)try{a=`<img class="user-avatar image-avatar" src="${`${y}${t.avatar.replace(".png","_big.png")}`}" alt="${n}'s avatar" \n              onerror="this.onerror=null; this.classList.add('fallback-avatar'); this.innerHTML='${nt()}'">`}catch(t){console.error(`Error loading avatar for ${n}:`,t),a=`<span class="user-avatar svg-avatar">${nt()}</span>`}else a=`<span class="user-avatar svg-avatar">${nt()}</span>`;e.innerHTML=`\n          ${a}\n          <div class="user-info">\n            <div class="username" style="color: ${t.usernameColor}">\n              <span class="username-clickable" data-user-id="${t.jid}">${n}</span>\n              <span class="role ${t.role}">${i}</span>\n            </div>\n          </div>\n        `}let i=e.querySelector(".game-indicator");if(t.gameId){if(!i||i.getAttribute("data-game-id")!==t.gameId){const n=`<span class="game-indicator" title="${t.gameId}" data-game-id="${t.gameId}">\n                                      <span class="traffic-icon">🚦</span>\n                                    </span>`;if(i)i.outerHTML=n;else{e.querySelector(".username").insertAdjacentHTML("beforeend",n)}}}else i&&i.remove();a.appendChild(e)})),this.container.innerHTML="",this.container.appendChild(a),n.forEach(((t,e)=>{t.remove()})),this.isFirstLoad||t.forEach((t=>{const e=this.container.querySelector(`.user-item[data-jid="${t}"]`);var n;e&&((n=e).classList.add("shake-effect"),setTimeout((()=>{n.classList.remove("shake-effect")}),500))})),this.isFirstLoad&&(this.isFirstLoad=!1)}async requestFullRoster(){console.log("📑 Would request full roster here (using existing data for now)"),this.updateUI()}}class Et{constructor(t="messages-panel",e=""){this.panel=document.getElementById(t),this.messages=[],this.messageIdCounter=0,this.currentUsername=e,this.sentMessageTexts=new Set,this.processedMessageIds=new Set,this.chatHistory=new Map}processMessages(t){if(!t||"string"!=typeof t)return;const e=(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("message");let n=!1;Array.from(e).forEach((t=>{const e=t.getAttribute("id")||"msg_"+this.messageIdCounter++;if(this.processedMessageIds.has(e))return;const i=t.getElementsByTagName("body")[0];if(i&&i.textContent){const a=i.textContent;if("This room is not anonymous"===a.trim())return;const o=t.getAttribute("from"),r=dt(o&&o.split("/")[1]||"unknown");let s=(new Date).toISOString();const c=t.getElementsByTagName("delay");c.length>0&&c[0].getAttribute("stamp")&&(s=c[0].getAttribute("stamp"));if(!(r===this.currentUsername&&this.sentMessageTexts.has(a))){const t={id:e,from:r,text:a,timestamp:s};this.messages.push(t),this.chatHistory.set(e,t),this.processedMessageIds.add(e),n=!0}}})),n&&this.updatePanel()}addSentMessage(t){this.sentMessageTexts.add(t);const e=`msg_${Date.now()}`,n={id:e,from:this.currentUsername,text:t,timestamp:(new Date).toISOString()};if(this.messages.push(n),this.chatHistory.set(e,n),this.processedMessageIds.add(e),this.updatePanel(),this.sentMessageTexts.size>20){const t=Array.from(this.sentMessageTexts);for(let e=0;e<t.length-20;e++)this.sentMessageTexts.delete(t[e])}}updatePanel(){if(!this.panel)return;this.messages.sort(((t,e)=>new Date(t.timestamp)-new Date(e.timestamp)));const t=new Set(Array.from(this.panel.querySelectorAll(".message")).map((t=>t.getAttribute("data-message-id"))));this.messages.forEach((e=>{if(!t.has(e.id)){const t=new Date(e.timestamp).toLocaleTimeString("en-GB",{hour12:!1}),n=G.getColor(e.from),i=document.createElement("div");i.className="message"+(e.from===this.currentUsername?" sent":""),e.text.startsWith("/me ")&&(i.classList.add("system"),e.text=`${e.from} ${e.text.substring(e.text.indexOf(" ")+1)}`),i.setAttribute("data-message-id",e.id);const a=document.createElement("div");a.className="message-info",a.innerHTML=`\n        <span class="time">${t}</span>\n        <span class="username" style="color: ${n}">${e.from}</span>\n      `;const o=document.createElement("div");o.className="message-text",o.innerHTML=e.text.replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,'<a href="$1" target="_blank">$1</a>').replace(/:(\w+):/g,((t,e)=>`<img src="https://klavogonki.ru/img/smilies/${e}.gif" alt="${e}" />`)),i.appendChild(a),i.appendChild(o),this.panel.appendChild(i)}})),this.addUsernameClickListeners(),ft(this.currentUsername),requestAnimationFrame((()=>{xt()}))}addUsernameClickListeners(){const t=this.panel.querySelectorAll(".username"),e=document.getElementById("message-input");t.forEach((t=>{t.addEventListener("click",(n=>{const i=t.textContent+", ";n.ctrlKey?e.value=i:e.value.includes(i)||(e.value+=i),e.focus()}))}))}getChatHistory(){return Array.from(this.chatHistory.values())}}function Lt(){const t=document.getElementById("app-chat-container"),e=document.querySelector(".chat-toggle-button");if(!t)return;if(t.classList.contains("maximized"))return void function(t,e={}){const n=document.querySelector(".chat-drag-area");if(!n)return;const i=n.querySelector(".chat-dynamic-alert");i&&n.removeChild(i);const a={type:"info",duration:3e3,...e},o={info:"#2196F3",warning:"#FF9800",error:"#F44336",success:"#4CAF50"},r=document.createElement("div");r.className="chat-dynamic-alert",r.innerHTML=t,r.style.cssText=`\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    color: ${o[a.type]||o.info};\n    padding: 5px 10px;\n    border-radius: 3px;\n    z-index: 1000;\n    font-family: Roboto, Montserrat;\n    font-size: 14px;\n    font-weight: normal;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n    opacity: 0;\n  `,n.appendChild(r),requestAnimationFrame((()=>{r.style.transition="all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55)",r.style.opacity="1",r.style.transform="translate(-50%, -50%)",setTimeout((()=>{r.style.transition="transform 0.05s ease-in-out",[{x:5,delay:0},{x:-7,delay:50},{x:9,delay:100},{x:-6,delay:150},{x:4,delay:200},{x:-3,delay:250},{x:0,delay:300}].forEach((t=>{setTimeout((()=>{r.style.transform=`translate(calc(-50% + ${t.x}px), -50%)`}),t.delay)}))}),300),setTimeout((()=>{r.style.transition="opacity 0.3s ease-in-out",r.style.opacity="0",setTimeout((()=>{n.removeChild(r)}),300)}),a.duration)}))}("Chat is currently maximized",{type:"warning",duration:1e3});const n=JSON.parse(localStorage.getItem("chatState"))||{};if(n.floating||!1){const i="0"===t.style.opacity;t.style.opacity=i?"1":"0",setTimeout((()=>{t.style.display=i?"flex":"none",e.innerHTML=i?Y:X,ct({...n,isVisible:i}),i&&vt()}),300)}else{const i=!t.classList.contains("visible-chat");t.classList.remove("visible-chat","hidden-chat"),t.classList.add(i?"visible-chat":"hidden-chat"),e.innerHTML=i?Y:X,ct({...n,isVisible:i}),i&&vt()}}function kt(){const t=document.createElement("div");t.id="app-chat-container",["top","left","right"].forEach((e=>{const n=document.createElement("div");n.className=`resize-handle ${e}`,t.appendChild(n)}));const e=document.createElement("div");e.className="chat-wrapper";const n=document.createElement("div");n.className="chat-content";const i=document.createElement("div");i.id="messages-panel",i.className="messages-panel";const a=document.createElement("div");a.className="input-container";const o=document.createElement("input");o.type="text",o.id="message-input";const r=document.createElement("button");r.id="send-button",r.className="filled-button send-button",r.innerHTML=J,a.appendChild(o),a.appendChild(r),n.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.className="user-list-container";const c=document.createElement("div");c.id="user-list",s.appendChild(c),e.appendChild(n),e.appendChild(s),t.appendChild(e);const l=document.createElement("button");l.className="filled-button header-button chat-maximize-button",l.innerHTML=Q,l.addEventListener("click",$t),t.appendChild(l);const d=document.createElement("button");d.className="filled-button header-button chat-toggle-button",d.innerHTML=Y,d.addEventListener("click",Lt),t.appendChild(d);const p=document.createElement("div");p.className="chat-drag-area",p.addEventListener("dblclick",Lt),t.appendChild(p),document.body.appendChild(t),at(),function(){if(!document.getElementById("app-chat-container"))return;const t=ot(),e=document.createElement("div");e.className="font-size-control";const n=document.createElement("input");n.type="range",n.min="0.8",n.max="1.5",n.step="0.1",n.value=t.fontSizeMultiplier,n.className="font-size-slider",n.addEventListener("mousedown",(t=>{t.stopPropagation()})),n.addEventListener("input",(t=>{rt(parseFloat(t.target.value))})),e.appendChild(n);const i=document.querySelector(".chat-drag-area");i&&i.appendChild(e)}(),st()}let St=null;function $t(){const t=document.getElementById("app-chat-container"),e=document.querySelector(".chat-maximize-button");if(t)if(t.classList.contains("maximized")){const n=document.getElementById("messages-panel"),i=n.scrollHeight-n.scrollTop-n.clientHeight<=300;if(t.maximizeResizeHandler&&(window.removeEventListener("resize",t.maximizeResizeHandler),delete t.maximizeResizeHandler),St){if(t.style.width=`${St.width}px`,t.style.height=`${St.height}px`,t.style.left=`${St.left}px`,t.style.maxWidth="",t.style.minWidth="",t.style.position="fixed",t.style.right="",t.style.margin="",t.style.transform="",t.style.top="auto",St.floating){const e=window.innerHeight,n=St.top;n+St.height<=e?t.style.top=`${n}px`:(t.style.bottom="0",t.style.top="auto")}else t.style.bottom="0",t.style.top="";ct({...ot(),width:St.width,height:St.height,left:St.left,top:St.top,floating:St.floating,isVisible:St.isVisible})}t.classList.remove("maximized"),e.classList.remove("maximized"),e.innerHTML=Q,requestAnimationFrame((()=>{it(),i&&(n.scrollTop=n.scrollHeight),vt(),st()}))}else{const n=!t.classList.contains("visible-chat")&&!t.classList.contains("hidden-chat");St=ot();const i=()=>`${Math.floor(.9*window.innerHeight)}px`;t.style.cssText=`\n      width: 100vw !important;\n      height: ${i()} !important;\n      max-width: 95vw !important;\n      min-width: 95vw !important;\n      position: fixed !important;\n      bottom: 0 !important;\n      left: 0 !important;\n      right: 0 !important;\n      top: auto !important;\n      margin: 0 !important;\n      transform: none !important;\n    `,n&&t.classList.remove("visible-chat","hidden-chat"),t.classList.add("maximized"),e.classList.add("maximized"),e.innerHTML=K;const a=()=>{t.style.height=i(),t.style.bottom="0",t.style.top="auto"};window.addEventListener("resize",a),t.maximizeResizeHandler=a,it(),vt(),st()}}let It,Mt,Ct,zt,Tt=!1;let At,Ht,Nt,Rt,Bt,qt,Pt=!1,jt=null,Ut=0;function Ft(){if(function(){try{return window!==window.top}catch(t){return!0}}())return console.error("Application cannot run in an iframe"),!1;const t=new URLSearchParams(window.location.search);if("/g/"===window.location.pathname&&t.has("gmid"))return!1;if(window.location.href.includes("/gamelist/"))return function(){if(window.location.href.startsWith("https://klavogonki.ru/gamelist/"))try{const t=Array.from(document.scripts).find((t=>t.text.includes("PageData")));if(!t)throw new Error("PageData script not found");const e=t.text.match(/\.constant\('PageData', ([\s\S]*?})\)/)[1],n=JSON.parse(e.replace(/(\w+):/g,'"$1":').replace(/'/g,'"')),i=`${n.chatParams.user.id}#${n.chatParams.user.login}`,a=n.chatParams.pass;localStorage.getItem("klavoauth")||(localStorage.setItem("klavoauth",JSON.stringify({username:i,password:a})),setTimeout((()=>{window.location.href="https://klavogonki.ru"}),500))}catch(t){console.error("Auth error:",t),localStorage.removeItem("klavoauth"),alert(`Auth failed: ${t.message}\nPlease refresh the page.`)}}(),!1;return!!(localStorage.getItem("klavoauth")&&x.username&&x.password)||(localStorage.removeItem("klavoauth"),window.location.href="https://klavogonki.ru/gamelist/",!1)}!async function(){try{if(!Ft())return;kt(),function(){const t=document.getElementById("app-chat-container"),e=document.getElementById("chat-close-btn"),n=document.getElementById("chat-header");if(!t)return;const i=JSON.parse(localStorage.getItem("chatState"))||{},a=i.floating||!1,o=!1!==i.isVisible;a?(t.style.display=o?"flex":"none",t.style.opacity=o?"1":"0"):(t.classList.remove("visible-chat","hidden-chat"),t.classList.add(o?"visible-chat":"hidden-chat")),document.addEventListener("keydown",(t=>{t.ctrlKey&&t.shiftKey&&"Space"===t.code?(t.preventDefault(),$t()):t.ctrlKey&&"Space"===t.code&&(t.preventDefault(),Lt())})),e&&e.addEventListener("click",Lt),n&&n.addEventListener("dblclick",Lt)}(),document.addEventListener("mousedown",(t=>{if(!t.target.closest(".chat-drag-area"))return;const e=document.getElementById("app-chat-container");let n=ot();if(Tt=!0,It=t.clientX,Mt=t.clientY,Ct=e.offsetLeft,zt=parseInt(e.style.top)||e.getBoundingClientRect().top,!n.floating){const t=window.innerHeight-e.offsetHeight;e.style.top=t+"px",e.style.bottom="",n.top=t,n.floating=!0,e.classList.add("floating-chat"),ct(n)}document.body.style.userSelect="none"})),document.addEventListener("mousemove",(t=>{if(!Tt)return;const e=document.getElementById("app-chat-container"),n=window.innerWidth,i=window.innerHeight,a=t.clientX-It,o=t.clientY-Mt,r=lt(Ct+a,0,n-e.offsetWidth),s=lt(zt+o,0,i-e.offsetHeight);e.style.left=r+"px",e.style.top=s+"px";let c=ot();c.left=r,c.top=s,c.floating=!0,ct(c)})),document.addEventListener("mouseup",(()=>{if(!Tt)return;Tt=!1;const t=document.getElementById("app-chat-container"),e=window.innerWidth,n=window.innerHeight,i=t.getBoundingClientRect(),a=i.left<0||i.top<0||i.right>e||i.bottom>n,o=n-i.bottom<50;let r=ot();a||o?(t.style.top="",t.style.bottom="0",r.floating=!1,t.classList.remove("floating-chat")):(r.floating=!0,r.top=i.top,t.classList.add("floating-chat")),ct(r),document.body.style.userSelect=""})),document.addEventListener("mousedown",(t=>{const e=t.target.closest(".resize-handle");if(!e)return;Pt=!0,jt=e.classList[1];const n=document.getElementById("app-chat-container");At=t.clientX,Ht=t.clientY,Nt=n.offsetWidth,Rt=n.offsetHeight,Bt=n.offsetLeft,qt=parseInt(n.style.top)||n.getBoundingClientRect().top,Ut=t.clientY-qt,document.body.style.userSelect="none"})),document.addEventListener("mousemove",(t=>{if(!Pt)return;const e=document.getElementById("app-chat-container"),n=window.innerWidth,i=window.innerHeight,a=getComputedStyle(document.documentElement),o=parseInt(a.getPropertyValue("--min-chat-width"))||250,r=parseInt(a.getPropertyValue("--min-chat-height"))||200;let s=ot();if("left"===jt){const i=Math.max(o,Nt-(t.clientX-At)),a=lt(Bt+(t.clientX-At),0,n-i);e.style.width=i+"px",e.style.left=a+"px",s.width=i,s.left=a}else if("right"===jt){const i=n-e.getBoundingClientRect().left,a=Math.min(i,Math.max(o,Nt+(t.clientX-At)));e.style.width=a+"px",s.width=a}const c=t.clientY-Ut;if("top"===jt)if(!1===s.floating){let t=lt(c,0,i-r),n=i-t;e.style.top=t+"px",e.style.height=n+"px",s.top=t,s.height=n}else{let t=lt(c,0,qt+Rt-r),n=Rt-(t-qt);n=Math.min(n,i),e.style.top=t+"px",e.style.height=n+"px",s.top=t,s.height=n}if("left"===jt||"right"===jt)if(!1===s.floating){let t=lt(c,0,i-r),n=i-t;e.style.top=t+"px",e.style.height=n+"px",s.top=t,s.height=n}else{let t=lt(c,0,qt+Rt-r),n=Rt-(t-qt);n=Math.min(n,i-t),e.style.top=t+"px",e.style.height=n+"px",s.top=t,s.height=n}e.offsetHeight>i&&(e.style.height=i+"px",!1===s.floating&&(e.style.top="0px",s.top=0),s.height=i),ct(s),it()})),document.addEventListener("mouseup",(()=>{Pt=!1,document.body.style.userSelect=""})),window.addEventListener("resize",(()=>{at(),it()})),function(){const t=document.getElementById("messages-panel");if(!t)return;new MutationObserver((()=>{it(),W(),P(),xt()})).observe(t,{childList:!0,subtree:!0})}();const t=new wt("user-list"),e=new Et("messages-panel",x.username),n=function(t,e,n,i){return{userManager:e,messageManager:n,async connect(){try{const a=await t.connect();console.log("💬 Step 8: Joining chat room...");const o=`<body rid='${t.nextRid()}' sid='${a.sid}'\n                 xmlns='http://jabber.org/protocol/httpbind'>\n            <presence id='pres_1' xmlns='jabber:client' to='general@conference.jabber.klavogonki.ru/${i}'>\n              <x xmlns='http://jabber.org/protocol/muc'/>\n            </presence>\n          </body>`,r=await t.sendRequestWithRetry(o);console.log("📥 Join response:",r),e.updatePresence(r),n.processMessages(r);const s=`<body rid='${t.nextRid()}' sid='${a.sid}'\n                 xmlns='http://jabber.org/protocol/httpbind'>\n            <iq type='get' id='info1' xmlns='jabber:client' to='general@conference.jabber.klavogonki.ru'>\n              <query xmlns='http://jabber.org/protocol/disco#info'/>\n            </iq>\n          </body>`;await t.sendRequestWithRetry(s),setInterval((async()=>{const i=await t.sendRequestWithRetry(`<body rid='${t.nextRid()}' sid='${a.sid}' xmlns='http://jabber.org/protocol/httpbind'/>`);e.updatePresence(i),n.processMessages(i)}),5e3),console.log("🚀 Step 10: Connected! Starting presence updates...")}catch(t){console.error(`💥 Error: ${t.message}`)}},sendMessage(e){const i=`msg_${Date.now()}`,a=`\n        <body rid='${t.nextRid()}' sid='${t.sid}' xmlns='http://jabber.org/protocol/httpbind'>\n          <message to='general@conference.jabber.klavogonki.ru'\n                   type='groupchat'\n                   id='${i}'\n                   xmlns='jabber:client'>\n            <body>${e}</body>\n          </message>\n        </body>\n      `;t.sendRequestWithRetry(a).then((t=>{n.processMessages(t)})).catch(console.error)}}}(new L({username:x.username,password:x.password,bindUrl:b,delay:200}),t,e,x.username),i=document.getElementById("message-input"),a=()=>{const t=i.value.trim();t&&(n.sendMessage(t),i.value=null,i.focus())};document.getElementById("send-button").addEventListener("click",a),i.addEventListener("keypress",(t=>"Enter"===t.key&&a())),await n.connect(),window.xmppClient=n}catch(t){console.error("App init error:",t),localStorage.removeItem("klavoauth"),window.location.href="https://klavogonki.ru/gamelist/"}}()})();