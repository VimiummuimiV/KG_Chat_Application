// ==UserScript==
// @name         KG_Chat_Application
// @namespace    klavogonki
// @version      1.0.0
// @description  Enhance the chat abilities
// @author       Patcher
// @match        *://klavogonki.ru/*
// @exclude      https://klavogonki.ru/g/?gmid=*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=klavogonki.ru
// @grant        none
// ==/UserScript==

(()=>{"use strict";var e={56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function n(e){for(var n=-1,i=0;i<t.length;i++)if(t[i].identifier===e){n=i;break}return n}function i(e,i){for(var o={},r=[],s=0;s<e.length;s++){var c=e[s],l=i.base?c[0]+i.base:c[0],d=o[l]||0,p="".concat(l," ").concat(d);o[l]=d+1;var m=n(p),h={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==m)t[m].references++,t[m].updater(h);else{var u=a(h,i);i.byIndex=s,t.splice(s,0,{identifier:p,updater:u,references:1})}r.push(p)}return r}function a(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,a){var o=i(e=e||[],a=a||{});return function(e){e=e||[];for(var r=0;r<o.length;r++){var s=n(o[r]);t[s].references--}for(var c=i(e,a),l=0;l<o.length;l++){var d=n(o[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}o=c}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},208:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(601),a=n.n(i),o=n(314),r=n.n(o)()(a());r.push([e.id,":root {\n  --border-radius: 0.2em;\n  --min-chat-width: 400px;\n  --min-chat-height: 200px;\n  --user-list-width: fit-content;\n}\n\n/* Main chat container */\n#app-chat-container {\n  border-radius: 0.4em 0.4em 0 0 !important;\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  height: 300px;\n  background: #1e1e1e !important;\n  border: 1px solid #333 !important;\n  display: flex;\n  font-family: sans-serif;\n  color: burlywood !important;\n  z-index: 999;\n  min-width: var(--min-chat-width) !important;\n  min-height: var(--min-chat-height) !important;\n  box-sizing: border-box;\n  max-width: 100vw;\n  overflow: hidden;\n  transition:\n    opacity 0.3s ease,\n    transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n}\n\n/* Chat container maximized state */\n#app-chat-container.maximized {\n  position: fixed;\n  z-index: 1010;\n}\n\n/* Responsive: hide user list on small screens */\n@media (max-width: 780px) {\n  #app-chat-container .user-list-container {\n    display: none !important;\n  }\n\n  #app-chat-container .chat-wrapper {\n    width: 100% !important;\n    border-right: none !important;\n  }\n}\n\n@media (max-width: 550px) {\n  #app-chat-container .message {\n    flex-direction: column !important;\n    margin-bottom: 1em !important;\n  }\n}\n\n#app-chat-container:not(.visible-chat):not(.hidden-chat):not(.maximized) {\n  display: none;\n  opacity: 0;\n}\n\n#app-chat-container.visible-chat {\n  transform: translateY(0) !important;\n}\n\n#app-chat-container.hidden-chat {\n  opacity: 1;\n  transform: translateY(calc(100% - 25px)) !important;\n}\n\n/* Resize handles */\n#app-chat-container .resize-handle {\n  position: absolute !important;\n  background: transparent !important;\n  z-index: 1000 !important;\n}\n\n#app-chat-container .resize-handle.top {\n  top: -3px !important;\n  left: 0 !important;\n  right: 0 !important;\n  height: 6px !important;\n  cursor: ns-resize !important;\n}\n\n#app-chat-container .resize-handle.left {\n  left: -3px !important;\n  top: 0 !important;\n  bottom: 0 !important;\n  width: 6px !important;\n  cursor: ew-resize !important;\n}\n\n#app-chat-container .resize-handle.right {\n  right: -3px !important;\n  top: 0 !important;\n  bottom: 0 !important;\n  width: 6px !important;\n  cursor: ew-resize !important;\n}\n\n/* Chat wrapper: two-column layout */\n#app-chat-container .chat-wrapper {\n  display: flex !important;\n  flex-direction: row !important;\n  flex: 1 !important;\n  min-width: var(--min-chat-width) !important;\n  overflow: hidden !important;\n}\n\n/* Left column: messages & input */\n#app-chat-container .chat-content {\n  margin-top: 25px !important;\n  background: #1e1e1e !important;\n  display: flex !important;\n  flex-direction: column !important;\n  flex: 1 !important;\n  overflow: hidden !important;\n}\n\n/* Messages panel takes most of the space */\n#app-chat-container .messages-panel {\n  flex: 1 !important;\n  overflow-y: auto !important;\n  padding: 1em !important;\n  display: flex !important;\n  flex-direction: column !important;\n  gap: 0.6em !important;\n}\n\n/* Input container at bottom */\n#app-chat-container .input-container {\n  display: flex !important;\n  padding: 1em !important;\n  gap: 0.5em !important;\n  border-top: 1px solid #333 !important;\n}\n\n#app-chat-container #message-input {\n  flex: 1 !important;\n  background: #2a2a2a !important;\n  color: burlywood !important;\n  padding: 0.5em !important;\n  border-radius: var(--border-radius) !important;\n  min-width: 0 !important;\n  border: none !important;\n}\n\n/* Right column: user list container */\n#app-chat-container .user-list-container {\n  margin-top: 25px;\n  width: var(--user-list-width) !important;\n  min-width: 180px !important;\n  max-width: var(--user-list-width) !important;\n  overflow-y: auto !important;\n  overflow-x: hidden !important;\n  padding: 1em !important;\n  background: #1e1e1e !important;\n  border-left: 1px solid #333 !important;\n}\n\n.user-item .user-info .username .role {\n  transition: filter 0.3s ease;\n}\n\n.user-item .user-info .username .role.participant {\n  filter: brightness(0.6);\n}\n\n.user-item .user-info .username .role.moderator {\n  filter: brightness(1);\n}\n\n.user-item .user-info .username .role.visitor {\n  filter: brightness(0.8);\n}\n\n/* Header toggle button */\n#app-chat-container .header-button {\n  cursor: pointer !important;\n  position: absolute !important;\n  top: 0 !important;\n  width: 25px !important;\n  height: 25px !important;\n  z-index: 5 !important;\n}\n\n#app-chat-container .filled-button {\n  border: none !important;\n  background-color: transparent !important;\n  transition: all 0.15s ease-out;\n}\n\n#app-chat-container .filled-button:hover {\n  filter: brightness(1.2) !important;\n}\n\n#app-chat-container .chat-toggle-button {\n  right: 0 !important;\n}\n\n/* Maximize button positioning and styling */\n.chat-maximize-button {\n  right: 25px !important;\n}\n\n/* Drag area for floating the chat */\n#app-chat-container .chat-drag-area {\n  border-radius: 0.4em 0.4em 0 0 !important;\n  position: absolute !important;\n  top: 0 !important;\n  left: 0 !important;\n  right: 0 !important;\n  height: 25px !important;\n  cursor: move !important;\n  background-color: rgba(22, 22, 22, 0.8) !important;\n}\n\n/* Specific styling for floating chats */\n#app-chat-container.floating-chat {\n  border-radius: 0.4em !important;\n}\n\n/* Message styles */\n#app-chat-container .message {\n  display: flex;\n  flex-direction: row;\n  padding: 0.08em 0.8em !important;\n  border-radius: var(--border-radius) !important;\n  width: fit-content !important;\n  max-width: 100% !important;\n  word-break: break-word !important;\n}\n\n#app-chat-container .message.system {\n  background-color: #deb88725 !important;\n  border: 1px solid #deb88750 !important;\n}\n\n#app-chat-container .message.sent {\n  background: #293e2985 !important;\n  border: 1px solid #293e29 !important;\n}\n\n#app-chat-container .message-info {\n  white-space: nowrap !important;\n  font-size: 0.9em !important;\n  line-height: 1.5em !important;\n  margin-right: 1em !important;\n}\n\n/* Add to existing style.css content */\n#app-chat-container .message-info .username,\n#app-chat-container .user-info .username {\n  cursor: pointer !important;\n  transition: opacity 0.2s ease !important;\n}\n\n#app-chat-container .message-info .username:hover,\n#app-chat-container .user-info .username:hover {\n  opacity: 0.7 !important;\n}\n\n#app-chat-container .message-info .time {\n  margin-right: 1em !important;\n  font-size: 0.9em !important;\n  color: #666 !important;\n}\n\n/* User list item styles */\n#app-chat-container .user-item {\n  display: flex !important;\n  align-items: center !important;\n  padding: 0.2em !important;\n  margin-bottom: 0.2em !important;\n  border-radius: var(--border-radius) !important;\n  max-width: 100% !important;\n  text-overflow: ellipsis !important;\n}\n\n#app-chat-container .user-avatar {\n  display: flex !important;\n  justify-content: center !important;\n  align-items: center !important;\n  width: 24px !important;\n  height: 24px !important;\n  font-size: 18px !important;\n  border-radius: 0.1em !important;\n  margin-right: 1em !important;\n  text-align: center !important;\n  line-height: 24px !important;\n  flex-shrink: 0 !important;\n}\n\n#app-chat-container .user-avatar.image-avatar {\n  cursor: pointer !important;\n  transform-origin: left !important;\n  transition: transform 0.15s ease-out !important;\n}\n\n#app-chat-container .user-avatar.image-avatar:hover {\n  transform: scale(2) !important;\n}\n\n#app-chat-container .user-avatar.svg-avatar {\n  filter: grayscale(0.5) !important;\n}\n\n#app-chat-container .user-info {\n  flex: 1 !important;\n  min-width: 0 !important;\n  overflow: hidden !important;\n  text-overflow: ellipsis !important;\n  white-space: nowrap !important;\n}\n\n#app-chat-container .user-meta {\n  cursor: default;\n  font-size: 0.8em !important;\n  color: #b0b0b0 !important;\n  overflow: hidden !important;\n  text-overflow: ellipsis !important;\n  white-space: nowrap !important;\n}\n\n#app-chat-container .game-link {\n  color: burlywood !important;\n  text-decoration: none !important;\n  transition: color 0.15s !important;\n}\n\n#app-chat-container .role-moderator {\n  color: #ff7e7e !important;\n}\n\n#app-chat-container .role-participant {\n  color: #7ed4ff !important;\n}\n\n#app-chat-container .role-visitor {\n  color: #b0b0b0 !important;\n}\n\n/* Dimming background style */\n.dimming-element {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background-color: rgba(0, 0, 0, 0.5);\n  z-index: 999 !important;\n  opacity: 0;\n  transition: opacity 0.3s ease;\n}\n\n/* convertImageLinksToImage */\n.clickable-thumbnail {\n  opacity: 1;\n  transition: opacity 0.15s ease-in-out;\n  border: none;\n  max-width: 150px !important;\n  max-height: 150px !important;\n  cursor: pointer;\n  background-color: transparent;\n  padding: 2px;\n  margin: 6px;\n  overflow-y: auto;\n}\n\n.clickable-thumbnail img {\n  border-radius: var(--border-radius) !important;\n  object-fit: contain;\n  height: 100%;\n  width: 100%;\n}\n\n.clickable-thumbnail:hover {\n  opacity: 0.8;\n}\n\n.scaled-thumbnail {\n  top: 50%;\n  left: 50%;\n  transform-origin: center center;\n  transform: translate(-50%, -50%) scale(1);\n  position: fixed;\n  opacity: 0;\n  z-index: 1000;\n  transform-origin: center center;\n  max-height: 90vh;\n  max-width: 90vw;\n  cursor: pointer;\n  border-radius: 0.6em !important;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.28) !important;\n}\n\n/* convertVideoLinksToPlayer */\n.video-wrapper {\n  display: flex;\n  flex-direction: column;\n}\n\n.video-wrapper .processed-video {\n  margin-bottom: 0.6em !important;\n}\n\n.video-container {\n  border-radius: 0.4em !important;\n  display: flex;\n  border: none;\n  height: 200px !important;\n  width: 356px !important\n}\n",""]);const s=r},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",i=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),i&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),i&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,i,a,o){"string"==typeof e&&(e=[[null,e,void 0]]);var r={};if(i)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(r[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);i&&r[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),t.push(d))}},t}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var t={};e.exports=function(e,n){var i=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var a=void 0!==n.layer;a&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,a&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var o=n.sourceMap;o&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function n(i){var a=t[i];if(void 0!==a)return a.exports;var o=t[i]={id:i,exports:{}};return e[i](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var i=n(72),a=n.n(i),o=n(825),r=n.n(o),s=n(659),c=n.n(s),l=n(56),d=n.n(l),p=n(540),m=n.n(p),h=n(113),u=n.n(h),g=n(208),f={};f.styleTagTransform=u(),f.setAttributes=d(),f.insert=c().bind(null,"head"),f.domAPI=r(),f.insertStyleElement=m();a()(g.A,f);g.A&&g.A.locals&&g.A.locals;const y="https://klavogonki.ru",b=`${y}/xmpp-httpbind/`,v={get username(){const e=localStorage.getItem("klavoauth");return e?JSON.parse(e).username:""},get password(){const e=localStorage.getItem("klavoauth");return e?JSON.parse(e).password:""}},x=["ğŸ˜€","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜ƒ","ğŸ˜„","ğŸ˜…","ğŸ˜†","ğŸ˜‰","ğŸ˜Š","ğŸ˜‹","ğŸ˜","ğŸ˜","ğŸ˜","ğŸ˜‘","ğŸ˜’","ğŸ˜“","ğŸ˜”","ğŸ˜•","ğŸ˜–","ğŸ˜—","ğŸ˜˜","ğŸ˜™","ğŸ˜š","ğŸ˜œ","ğŸ˜","ğŸ˜›","ğŸ¤‘","ğŸ¤—","ğŸ¤”","ğŸ¤","ğŸ¤¨","ğŸ˜£","ğŸ˜¥","ğŸ˜®","ğŸ¤¯","ğŸ˜³","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ˜¢","ğŸ¤ª","ğŸ˜µ","ğŸ˜²","ğŸ¤¤","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤¢","ğŸ¤§","ğŸ˜‡","ğŸ¥³","ğŸ¥º","ğŸ˜¬","ğŸ˜´","ğŸ˜Œ","ğŸ¤¥","ğŸ¥´","ğŸ¥µ","ğŸ¥¶","ğŸ¤§","ğŸ¤­","ğŸ¤«","ğŸ˜ ","ğŸ˜¡","ğŸ˜³","ğŸ˜","ğŸ˜Ÿ","ğŸ˜•","ğŸ±","ğŸ˜º","ğŸ˜¸","ğŸ˜¹","ğŸ˜»","ğŸ˜¼","ğŸ˜½","ğŸ™€","ğŸ˜¿","ğŸ˜¾","ğŸ¶","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ™ˆ","ğŸ™‰","ğŸ™Š","ğŸ”","ğŸ¦„"];let w={bigImageEvents:{}};const E=["klavogonki.ru","youtube.com","youtu.be","imgur.com","pikabu.ru","userapi.com","ibb.co","yaplakal.com","freepik.com"];class L{constructor({username:e,password:t,bindUrl:n,delay:i=1e3}){this.username=e,this.password=t,this.bindUrl=n,this.delay=i,this.sid=null,this.rid=Math.floor(Date.now()/1e3)}nextRid(){return++this.rid}async sendRequest(e){const t=await fetch(this.bindUrl,{method:"POST",headers:{"Content-Type":"text/xml; charset=UTF-8","User-Agent":"Mozilla/5.0"},body:e});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.text()}async sendRequestWithRetry(e,t=5){let n,i=this.delay;for(let a=1;a<=t;a++)try{return await this.sendRequest(e)}catch(e){if(n=e,!e.message.includes("429"))throw e;{const e=i*Math.pow(2,a);console.log(`â±ï¸ Rate limited (attempt ${a}/${t}). Waiting ${e}ms...`),await this.sleep(e)}}throw new Error(`Max retries reached. Last error: ${n.message}`)}sleep(e){return new Promise((t=>setTimeout(t,e)))}base64Encode(e){const t=(new TextEncoder).encode(e);return btoa(String.fromCharCode(...t))}async connect(){console.log("ğŸŒ Step 1: Connecting to XMPP server...");const e=`<body xmlns='http://jabber.org/protocol/httpbind'\n               rid='${this.nextRid()}'\n               to='jabber.klavogonki.ru'\n               xml:lang='en'\n               wait='60'\n               hold='1'\n               ver='1.6'\n               xmpp:version='1.0'\n               xmlns:xmpp='urn:xmpp:xbosh'/>`,t=await this.sendRequestWithRetry(e);this.sid=t.match(/sid=['"]([^'"]+)['"]/)[1],console.log(`ğŸ”‘ Step 2: Session ID received: ${this.sid}`),await this.sleep(this.delay/8),console.log("ğŸ” Step 3: Authenticating...");const n=this.base64Encode("\0"+this.username+"\0"+this.password),i=`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>${n}</auth>\n        </body>`;if(!(await this.sendRequestWithRetry(i)).includes("<success"))throw new Error("âŒ Authentication failed");console.log("âœ… Step 4: Authentication successful!"),await this.sleep(this.delay/8),console.log("ğŸ”„ Step 5: Restarting stream...");const a=`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'\n               to='jabber.klavogonki.ru'\n               xmpp:restart='true'\n               xmlns:xmpp='urn:xmpp:xbosh'/>`;await this.sendRequestWithRetry(a),await this.sleep(this.delay/8),console.log("ğŸ“¦ Step 6: Binding resource...");const o=`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <iq type='set' id='bind_1' xmlns='jabber:client'>\n            <bind xmlns='urn:ietf:params:xml:ns:xmpp-bind'>\n              <resource>web</resource>\n            </bind>\n          </iq>\n        </body>`;await this.sendRequestWithRetry(o),await this.sleep(this.delay/8),console.log("ğŸ”Œ Step 7: Establishing session...");const r=`<body rid='${this.nextRid()}' sid='${this.sid}'\n               xmlns='http://jabber.org/protocol/httpbind'>\n          <iq type='set' id='session_1' xmlns='jabber:client'>\n            <session xmlns='urn:ietf:params:xml:ns:xmpp-session'/>\n          </iq>\n        </body>`;return await this.sendRequestWithRetry(r),await this.sleep(this.delay/8),{sid:this.sid,rid:this.rid}}}const $=["jpg","jpeg","png","gif","webp"],k="ğŸ“¸",S="ğŸ–¥ï¸",I="ğŸ’€ï¸ï¸",M=.2,C=10,T=.1;let A=0,z=!1,H=[],N=null;const R=e=>{const t=(e=>{try{return e.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||""}catch(e){return console.error("Error extracting extension:",e.message),""}})(e);return{allowed:$.includes(t),extension:t}},q=(e,t)=>{const n=document.createElement("img");n.src=e,n.classList.add("scaled-thumbnail"),document.body.appendChild(n),A=t;let i=1,a=!1,o=0,r=0,s=0,c=0;let l=document.querySelector(".dimming-element");l||(l=document.createElement("div"),l.classList.add("dimming-element"),document.body.appendChild(l));const d=e=>{de(e,"hide","0"),!document.querySelector(".popup-panel")&&l&&de(l,"hide","0"),le()};return w.bigImageEvents.click=e=>{n.contains(e.target)||(n.remove(),le())},w.bigImageEvents.keydown=e=>{"Escape"===e.code||"Space"===e.code?(e.preventDefault(),d(n)):"ArrowLeft"===e.code?B(-1):"ArrowRight"===e.code&&B(1)},w.bigImageEvents.wheel=e=>{const t=e.deltaY<0?1:-1;i+=t*T*i,i=Math.max(M,Math.min(i,C)),n.style.transform=`translate(-50%, -50%) translate(${s}px, ${c}px) scale(${i})`},w.bigImageEvents.mousemove=e=>{if(a){if(e.ctrlKey){const t=e.clientY-r,n=t<0?1:-1,a=Math.abs(t)*T*.05;i+=n*a*i,i=Math.max(M,Math.min(i,C))}else{const t=(e.clientX-o)/i*5,n=(e.clientY-r)/i*5;s+=t,c+=n}n.style.transform=`translate(-50%, -50%) translate(${s}px, ${c}px) scale(${i})`,o=e.clientX,r=e.clientY}},w.bigImageEvents.mousedown=e=>{const{button:t,clientX:i,clientY:s,target:c,ctrlKey:l}=e;(0!==t&&2!==t||c===n)&&(0===t?B(-1):2===t?(e.preventDefault(),l?(navigator.clipboard.writeText(c.src).catch(console.error),d(n)):B(1)):1===t&&(a=!0,o=i,r=s,e.preventDefault()))},w.bigImageEvents.mouseup=e=>{1===e.button&&(a=!1)},w.bigImageEvents.contextmenu=e=>e.preventDefault(),Object.entries(w.bigImageEvents).forEach((([e,t])=>{document.addEventListener(e,t)})),de(l,"show","1"),l.addEventListener("click",(()=>{d(n)})),n},B=e=>{const t=A+e;t>=0&&t<H.length&&!z&&(z=!0,N&&(N.src=H[t].imgSrc),setTimeout((()=>z=!1),50),A=t)};function P(e){const t=document.getElementById("messages-panel");if(!t)return;const n=t.querySelectorAll("a:not(.skipped):not(.processed-image)");function i(e,n){const i=document.createElement("div");i.classList.add("clickable-thumbnail"),i.dataset.sourceLink=e.href;const a=document.createElement("img");a.src=e.href,a.onload=()=>{i.appendChild(a),e.parentNode.insertBefore(i,e.nextSibling)},a.onerror=()=>{console.error("Failed to load image:",e.href),e.classList.add("skipped")},n?e.querySelector(".clickable-thumbnail")||e.addEventListener("click",(t=>{e.querySelector(".clickable-thumbnail")||(i.appendChild(a),e.parentNode.insertBefore(i,e.nextSibling))})):(i.appendChild(a),e.parentNode.insertBefore(i,e.nextSibling)),i.addEventListener("click",(n=>{n.stopPropagation(),H=[],t.querySelectorAll(".clickable-thumbnail").forEach(((e,t)=>{const n=e.querySelector("img");n&&e.dataset.sourceLink&&H.push({link:e.dataset.sourceLink,imgSrc:n.src,index:t})}));const i=H.findIndex((t=>t.link===e.href||t.imgSrc===a.src));N=q(a.src,i>=0?i:0),de(N,"show","1");const o=document.querySelector(".dimming-element");o&&de(o,"show","1")}))}n.length&&n.forEach((e=>{if(!e.href||!e.href.startsWith("http"))return;const{allowed:t,extension:n}=R(e.href);if(!t)return;e.classList.add("media");const{isTrusted:a,domain:o}=pe(e.href);e.title=me(e.href)?he(e.href):e.href,a?function(e,t,n){e.textContent=`${k} Image (${t.toUpperCase()}) ${S} Hostname (${n})`,e.classList.add("processed-image"),i(e,!1)}(e,n,o):function(e,t,n){e.classList.add("skipped"),e.textContent=`${k} Image (${t.toUpperCase()}) ${S} Hostname (${n}) ${I} Untrusted`,e.addEventListener("click",(t=>{e.classList.contains("processed-image")||(t.preventDefault(),e.classList.remove("skipped"),e.classList.add("processed-image"),i(e,!0))}))}(e,n,o)}))}const j="ğŸ¥",U="ğŸ–¥ï¸",W="ğŸ’€ï¸ï¸",D=["mp4","webm","ogg","mov","avi"];function F(e){const t=document.getElementById("messages-panel");if(!t)return;const n=t.querySelectorAll("a:not(.skipped):not(.processed-video)");function i(e,t,n,i){const{youtubeMatch:a,videoType:o,videoId:r}=i,s=(e=>{const t=e.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||"";return{allowed:D.includes(t),extension:t}})(t);if(!a&&!s.allowed)return;e.classList.add("processed-video");const c=document.createElement("div");c.classList.add("video-wrapper");const l=document.createElement(a?"iframe":"video");l.classList.add("video-container"),e.textContent=`${j} ${o} ${U} Hostname (${n})`,a?(l.src=`https://www.youtube.com/embed/${r}`,l.allowFullscreen=!0):(l.src=t,l.controls=!0),e.title=me(t)?he(t):t,e.style.display="inline-flex",e.parentNode.insertBefore(c,e),c.append(e,l)}n.length&&n.forEach((e=>{const t=e.href;if(!t)return;const n=function(e){const t=e.match(/(?:shorts\/|live\/|watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);if(t){return{youtubeMatch:!0,videoId:t[1],videoType:e.includes("shorts/")?"Shorts":e.includes("live/")?"Live":e.includes("watch?v=")?"Watch":e.includes("youtu.be/")?"Share":"YouTube"}}const n=e.split(".").pop().toLowerCase();if(D.includes(n))return{youtubeMatch:!1,videoType:`Video (${n.toUpperCase()})`};return!1}(t);if(!n)return;e.classList.add("media");const{isTrusted:a,domain:o}=pe(t);if(!a)return e.classList.add("skipped"),e.textContent=`${j} ${n.videoType} ${U} Hostname (${o}) ${W} Untrusted`,void e.addEventListener("click",(a=>{e.classList.contains("processed-video")||(a.preventDefault(),e.classList.remove("skipped"),i(e,t,o,n))}));i(e,t,o,n)}))}const O="http://www.w3.org/2000/svg",_="#82B32A",V="#B34A2A",J=`\n  <svg xmlns="${O}" \n      width="24" \n      height="24" \n      viewBox="0 0 250 250">\n    <path fill="#096AD9" d="M22.32 98.04l-19.04 -87.15c-0.75,-3.46 0.48,-6.84 3.29,-9 2.81,-2.17 6.39,-2.49 9.55,-0.87l225.95 116.02c3.07,1.57 4.87,4.52 4.87,7.96 0,3.44 -1.8,6.39 -4.87,7.96l-225.95 116.02c-3.16,1.62 -6.74,1.3 -9.55,-0.87 -2.81,-2.16 -4.04,-5.54 -3.29,-9l19.04 -87.15c0.79,-3.62 3.53,-6.26 7.18,-6.91l102.6 -18.19c0.91,-0.16 1.56,-0.94 1.56,-1.86 0,-0.92 -0.65,-1.7 -1.56,-1.86l-102.6 -18.19c-3.65,-0.65 -6.39,-3.29 -7.18,-6.91z"/>\n  </svg>\n`,Y=`\n  <svg xmlns="${O}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250" \n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n      <path fill="${_}" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm45.71 70.24l32.67 32.67 32.67 -32.67c2.73,-2.73 7.18,-2.73 9.91,0l12.18 12.18c2.73,2.73 2.73,7.18 0,9.91l-32.67 32.67 32.67 32.66c2.73,2.74 2.73,7.19 0,9.92l-12.18 12.18c-2.73,2.73 -7.18,2.73 -9.91,0l-32.67 -32.67 -32.67 32.67c-2.73,2.73 -7.18,2.73 -9.91,0l-12.18 -12.18c-2.73,-2.73 -2.73,-7.18 0,-9.92l32.67 -32.66 -32.67 -32.67c-2.73,-2.73 -2.73,-7.18 0,-9.91l12.18 -12.18c2.73,-2.73 7.18,-2.73 9.91,0z"/>\n  </svg>\n`,X=`\n  <svg xmlns="${O}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250" \n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n      <path fill="${V}" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm15.5 135.79l57.92 -57.93c2.73,-2.73 7.19,-2.72 9.92,0.01l57.92 57.92c2.73,2.73 2.73,7.18 0,9.91l-12.18 12.18c-2.73,2.73 -7.18,2.73 -9.92,0l-35.82 -35.83c-2.73,-2.73 -7.19,-2.73 -9.92,0l-35.82 35.83c-2.74,2.73 -7.19,2.73 -9.92,0l-12.18 -12.18c-2.73,-2.73 -2.73,-7.18 0,-9.91z"/>\n  </svg>\n`,K=`\n  <svg xmlns="${O}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250"\n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n    <path fill="${_}" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm109.99 181.69l-75.07 0c-7.3,0 -13.23,-5.92 -13.23,-13.22l0 -75.08c0,-2.35 1.92,-4.28 4.28,-4.28l17.9 0c2.35,0 4.27,1.93 4.27,4.28l0 32.81c0,1.77 1.01,3.28 2.64,3.96 1.63,0.67 3.42,0.33 4.66,-0.93l59.68 -59.68c1.67,-1.65 4.38,-1.65 6.05,0l12.66 12.66c1.66,1.67 1.66,4.38 0,6.05l-59.68 59.68c-1.26,1.24 -1.6,3.03 -0.93,4.66 0.68,1.63 2.19,2.64 3.96,2.64l32.81 0c2.35,0 4.28,1.92 4.28,4.28l0 17.9c0,2.36 -1.93,4.28 -4.28,4.28z"/>\n  </svg>\n`,Q=`\n  <svg xmlns="${O}" \n       width="15" \n       height="15" \n       viewBox="0 0 250 250"\n       style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd">\n    <path fill="${V}" d="M46.62 0l156.76 0c25.64,0 46.62,20.98 46.62,46.62l0 156.75c0,25.65 -20.98,46.63 -46.62,46.63l-156.76 0c-25.64,0 -46.62,-20.98 -46.62,-46.63l0 -156.75c0,-25.64 20.98,-46.62 46.62,-46.62zm46.77 68.31l75.07 0c7.3,0 13.23,5.92 13.23,13.22l0 75.08c0,2.35 -1.92,4.28 -4.28,4.28l-17.9 0c-2.35,0 -4.27,-1.93 -4.27,-4.28l0 -32.81c0,-1.77 -1.01,-3.28 -2.64,-3.96 -1.63,-0.67 -3.42,-0.33 -4.66,0.93l-59.68 59.68c-1.67,1.65 -4.38,1.65 -6.05,0l-12.66 -12.66c-1.66,-1.67 -1.66,-4.38 0,-6.05l59.68 -59.68c1.26,-1.24 1.6,-3.03 0.93,-4.66 -0.68,-1.63 -2.19,-2.64 -3.96,-2.64l-32.81 0c-2.35,0 -4.28,-1.92 -4.28,-4.27l0 -17.9c0,-2.36 1.93,-4.28 4.28,-4.28z"/>\n  </svg>\n`;function Z(e){return{hueMap:{},hueStep:e.hueStep||30,maxHue:e.maxHue||360,saturation:e.saturation||"80%",lightness:e.lightness||"50%",getColor(e){let t=this.hueMap[e];if(!t){const n=this.maxHue/this.hueStep;t=Math.floor(Math.random()*n)*this.hueStep,this.hueMap[e]=t}return`hsl(${t}, ${this.saturation}, ${this.lightness})`}}}const G=Z({maxHue:210,hueStep:30,saturation:"80%",lightness:"50%"}),ee=Z({maxHue:210,hueStep:30,saturation:"80%",lightness:"50%"});let te=null;function ne(){let e;do{e=x[Math.floor(Math.random()*x.length)]}while(e===te);return te=e,e}function ie(){const e=document.querySelector("#app-chat-container .chat-wrapper");if(!e)return;const t=document.querySelector("#app-chat-container"),n=e.offsetWidth<=780,i=t.classList.contains("maximized"),a=document.querySelector("#app-chat-container .user-list-container");a&&(a.style.display=n&&!i?"none":""),document.querySelectorAll("#app-chat-container .message").forEach((e=>{e.style.flexDirection=n&&!i?"column":"row",e.style.marginBottom=n&&!i?"1em":"0"}))}function ae(){const e=document.getElementById("app-chat-container"),t=document.querySelector(".chat-toggle-button");if(!e||!t)return;const n=oe(),i=window.innerWidth,a=window.innerHeight,o=getComputedStyle(document.documentElement),r=parseInt(o.getPropertyValue("--min-chat-width"))||250,s=parseInt(o.getPropertyValue("--min-chat-height"))||200;e.style.width=Math.min(i,Math.max(r,n.width))+"px",e.style.height=Math.min(a,Math.max(s,n.height))+"px",e.style.left=se(n.left,0,i-e.offsetWidth)+"px",n.floating?(e.style.top=se(n.top,0,a-e.offsetHeight)+"px",e.style.bottom="",e.classList.add("floating-chat"),e.style.display=n.isVisible?"flex":"none",e.style.opacity=n.isVisible?"1":"0",t.innerHTML=n.isVisible?Y:X):(e.style.bottom="0",e.style.top="",e.classList.remove("floating-chat"),e.classList.remove("visible-chat","hidden-chat"),e.classList.add(n.isVisible?"visible-chat":"hidden-chat"),t.innerHTML=n.isVisible?Y:X),ie()}function oe(){const e=localStorage.getItem("chatState"),t={height:300,width:Math.min(window.innerWidth,600),left:0,floating:!1,top:window.innerHeight-300,isVisible:!0};return e?{...t,...JSON.parse(e)}:t}function re(e){localStorage.setItem("chatState",JSON.stringify(e))}function se(e,t,n){return Math.min(Math.max(e,t),n)}function ce(e){return"string"!=typeof e?e:e.replace(/^\d+#/,"")}function le(){Object.entries(w.bigImageEvents).forEach((([e,t])=>{document.removeEventListener(e,t)}))}function de(e,t,n){e&&(e.offsetHeight,e.style.transition="opacity 0.3s",e.style.opacity="show"===t?n:"0","hide"===t&&e.addEventListener("transitionend",(()=>{"0"===e.style.opacity&&e.remove()}),{once:!0}))}const pe=e=>{try{const{hostname:t}=new URL(e),n=t.toLowerCase().split(".").slice(-2).join(".");return{isTrusted:E.includes(n),domain:n}}catch(t){return console.error("Error in isTrustedDomain:",t.message),{isTrusted:!1,domain:e}}};function me(e){return/^https?:\/\//.test(e)&&/%[0-9A-Fa-f]{2}/.test(e)}function he(e){const[t]=e.split("#");return decodeURIComponent(t).replace(/ /g,"_")}function ue(){const e=document.getElementById("messages-panel");if(!e)return;const t=localStorage.getItem("mentionKeywords");if(!t)return;let n;try{if(n=JSON.parse(t),!Array.isArray(n))return}catch(e){return}const i=new WeakSet;e.querySelectorAll(".message-text").forEach((e=>{const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:e=>{if(i.has(e))return NodeFilter.FILTER_SKIP;return e.parentElement.closest(".mention, .time, .username")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}}),a=[];let o;for(;o=t.nextNode();)a.push(o);a.forEach((e=>{i.has(e)||(!function(e,t){const n=/(@?[\wĞ°-ÑĞ-Ğ¯Ñ‘Ğ'-]+)|[\s]+|[^@\s\wĞ°-ÑĞ-Ğ¯Ñ‘Ğ'-]+/gu,i=e.textContent.match(n)||[],a=document.createDocumentFragment();i.forEach((e=>{if(t.some((t=>0===t.localeCompare(e,void 0,{sensitivity:"accent"})))){const t=document.createElement("span");t.className="mention",e.split("").forEach((e=>{const n=document.createElement("span");n.style.color=ee.getColor(e),n.textContent=e,t.appendChild(n)})),a.appendChild(t)}else a.appendChild(document.createTextNode(e))})),e.parentNode.replaceChild(a,e)}(e,n),i.add(e))}))}))}let ge=!0;const fe=300;function ye(){const e=document.getElementById("messages-panel");if(e)if(ge)e.scrollTop=e.scrollHeight,ge=!1;else{e.scrollHeight-e.scrollTop-e.clientHeight<=fe&&(e.scrollTop=e.scrollHeight)}}class be{constructor(e="user-list"){this.container=document.getElementById(e),this.activeUsers=new Map,this.isFirstLoad=!0,this.roleIcons={visitor:"ğŸ¥",participant:"ğŸ—¿",moderator:"âš”ï¸ï¸"},this.rolePriority={moderator:1,participant:2,visitor:3}}updatePresence(e){const t=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("presence");if(e.includes('<presence id="pres_1"'))return console.log("ğŸ”„ Initial room join detected, requesting full roster"),void this.requestFullRoster();let n=!1;const i=[],a=[];for(let e=0;e<t.length;e++){const o=t[e],r=o.getAttribute("from");if("unavailable"===o.getAttribute("type")){this.activeUsers.has(r)&&(console.log(`ğŸšª User left: ${this.activeUsers.get(r).login||r}`),this.activeUsers.delete(r),n=!0);continue}let s=null;const c=o.getElementsByTagName("x");for(let e=0;e<c.length;e++)if("klavogonki:userdata"===c[e].namespaceURI){s=c[e];break}if(!s){console.log(`âš ï¸ No klavogonki:userdata found for presence from: ${r}`);continue}const l=s.getElementsByTagName("user")[0];if(!l){console.log(`âš ï¸ No user node found in klavogonki:userdata for presence from: ${r}`);continue}const d=ce(l.getElementsByTagName("login")[0]?.textContent||"Anonymous"),p=l.getElementsByTagName("avatar")[0]?.textContent,m=l.getElementsByTagName("background")[0]?.textContent||"#777",h=s.getElementsByTagName("game_id")[0]?.textContent||null,u=l.getElementsByTagName("moderator")[0],g=u&&"1"===u.textContent,f=o.getElementsByTagName("item")[0];let y=f?.getAttribute("role")||"participant";g&&(y="moderator");const b={jid:r,login:d,avatar:p,color:m,role:y,usernameColor:G.getColor(d),gameId:h},v=this.activeUsers.get(r);v?JSON.stringify(v)!==JSON.stringify(b)&&(console.log(`ğŸ‘¤ User updated: ${d}`),this.activeUsers.set(r,b),n=!0,a.push(r)):(console.log(`ğŸ‘¤ User joined: ${d}`),this.activeUsers.set(r,b),n=!0,i.push(r))}n&&(console.log(`ğŸ“‹ Current active users: ${this.activeUsers.size}`),this.updateUI(i,a))}updateUI(e=[],t=[]){console.log(`ğŸ–¥ï¸ Updating UI with ${this.activeUsers.size} users`);const n=new Map;this.container.querySelectorAll(".user-item").forEach((e=>{n.set(e.getAttribute("data-jid"),e)}));const i=Array.from(this.activeUsers.values()).sort(((e,t)=>{const n=this.rolePriority[e.role]-this.rolePriority[t.role];return 0!==n?n:e.login.localeCompare(t.login)})),a=document.createDocumentFragment();i.forEach((e=>{let t=n.get(e.jid);if(t){n.delete(e.jid);const i=t.querySelector(".role"),a=this.roleIcons[e.role]||"ğŸ‘¤";i&&(i.textContent!==a&&(i.textContent=a),i.classList.contains(e.role)||(i.className=`role ${e.role}`))}else{t=document.createElement("div"),t.classList.add("user-item"),t.setAttribute("data-jid",e.jid);const n=ce(e.login),i=this.roleIcons[e.role]||"ğŸ‘¤";let a="";if(e.avatar)try{a=`<img class="user-avatar image-avatar" src="${`${y}${e.avatar.replace(".png","_big.png")}`}" alt="${n}'s avatar" \n              onerror="this.onerror=null; this.classList.add('fallback-avatar'); this.innerHTML='${ne()}'">`}catch(e){console.error(`Error loading avatar for ${n}:`,e),a=`<span class="user-avatar svg-avatar">${ne()}</span>`}else a=`<span class="user-avatar svg-avatar">${ne()}</span>`;t.innerHTML=`\n          ${a}\n          <div class="user-info">\n            <div class="username" style="color: ${e.usernameColor}">\n              <span class="username-clickable" data-user-id="${e.jid}">${n}</span>\n              <span class="role ${e.role}">${i}</span>\n            </div>\n          </div>\n        `}let i=t.querySelector(".game-indicator");if(e.gameId){if(!i||i.getAttribute("data-game-id")!==e.gameId){const n=`<span class="game-indicator" title="${e.gameId}" data-game-id="${e.gameId}">\n                                      <span class="traffic-icon">ğŸš¦</span>\n                                    </span>`;if(i)i.outerHTML=n;else{t.querySelector(".username").insertAdjacentHTML("beforeend",n)}}}else i&&i.remove();a.appendChild(t)})),this.container.innerHTML="",this.container.appendChild(a),n.forEach(((e,t)=>{e.remove()})),this.container.querySelectorAll(".username-clickable").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.getAttribute("data-user-id");if(t){const e=t.split("/")[1].split("#")[0];window.location.href=`https://klavogonki.ru/u/#/${e}/`}}))})),this.container.querySelectorAll(".game-indicator").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();const n=e.getAttribute("data-game-id");n&&(window.location.href=`https://klavogonki.ru/g/?gmid=${n}`)}))})),this.isFirstLoad||e.forEach((e=>{const t=this.container.querySelector(`.user-item[data-jid="${e}"]`);var n;t&&((n=t).classList.add("shake-effect"),setTimeout((()=>{n.classList.remove("shake-effect")}),500))})),this.isFirstLoad&&(this.isFirstLoad=!1)}async requestFullRoster(){console.log("ğŸ“‘ Would request full roster here (using existing data for now)"),this.updateUI()}}class ve{constructor(e="messages-panel",t=""){this.panel=document.getElementById(e),this.messages=[],this.messageIdCounter=0,this.currentUsername=t,this.sentMessageTexts=new Set,this.processedMessageIds=new Set,this.chatHistory=new Map}processMessages(e){if(!e||"string"!=typeof e)return;const t=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("message");let n=!1;Array.from(t).forEach((e=>{const t=e.getAttribute("id")||"msg_"+this.messageIdCounter++;if(this.processedMessageIds.has(t))return;const i=e.getElementsByTagName("body")[0];if(i&&i.textContent){const a=i.textContent;if("This room is not anonymous"===a.trim())return;const o=e.getAttribute("from"),r=ce(o&&o.split("/")[1]||"unknown");let s=(new Date).toISOString();const c=e.getElementsByTagName("delay");c.length>0&&c[0].getAttribute("stamp")&&(s=c[0].getAttribute("stamp"));if(!(r===this.currentUsername&&this.sentMessageTexts.has(a))){const e={id:t,from:r,text:a,timestamp:s};this.messages.push(e),this.chatHistory.set(t,e),this.processedMessageIds.add(t),n=!0}}})),n&&this.updatePanel()}addSentMessage(e){this.sentMessageTexts.add(e);const t=`msg_${Date.now()}`,n={id:t,from:this.currentUsername,text:e,timestamp:(new Date).toISOString()};if(this.messages.push(n),this.chatHistory.set(t,n),this.processedMessageIds.add(t),this.updatePanel(),this.sentMessageTexts.size>20){const e=Array.from(this.sentMessageTexts);for(let t=0;t<e.length-20;t++)this.sentMessageTexts.delete(e[t])}}updatePanel(){if(!this.panel)return;this.messages.sort(((e,t)=>new Date(e.timestamp)-new Date(t.timestamp)));const e=new Set(Array.from(this.panel.querySelectorAll(".message")).map((e=>e.getAttribute("data-message-id"))));this.messages.forEach((t=>{if(!e.has(t.id)){const e=new Date(t.timestamp).toLocaleTimeString("en-GB",{hour12:!1}),n=G.getColor(t.from),i=document.createElement("div");i.className="message"+(t.from===this.currentUsername?" sent":""),t.text.startsWith("/me ")&&(i.classList.add("system"),t.text=`${t.from} ${t.text.substring(t.text.indexOf(" ")+1)}`),i.setAttribute("data-message-id",t.id);const a=document.createElement("div");a.className="message-info",a.innerHTML=`\n        <span class="time">${e}</span>\n        <span class="username" style="color: ${n}">${t.from}</span>\n      `;const o=document.createElement("div");o.className="message-text",o.innerHTML=t.text.replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,'<a href="$1" target="_blank">$1</a>').replace(/:(\w+):/g,((e,t)=>`<img src="https://klavogonki.ru/img/smilies/${t}.gif" alt="${t}" />`)),i.appendChild(a),i.appendChild(o),this.panel.appendChild(i)}})),this.addUsernameClickListeners(),ue(this.currentUsername),requestAnimationFrame((()=>{ye()}))}addUsernameClickListeners(){const e=this.panel.querySelectorAll(".username"),t=document.getElementById("message-input");e.forEach((e=>{e.addEventListener("click",(n=>{const i=e.textContent+", ";n.ctrlKey?t.value=i:t.value.includes(i)||(t.value+=i),t.focus()}))}))}getChatHistory(){return Array.from(this.chatHistory.values())}}function xe(){const e=document.getElementById("app-chat-container"),t=document.querySelector(".chat-toggle-button");if(!e)return;const n=JSON.parse(localStorage.getItem("chatState"))||{};if(n.floating||!1)e.style.opacity="0"===e.style.opacity?"1":"0",setTimeout((()=>{e.style.display="0"===e.style.opacity?"none":"flex",t.innerHTML="none"===e.style.display?X:Y,re({...n,isVisible:"none"!==e.style.display})}),300);else{const i=e.classList.contains("visible-chat");e.classList.remove("visible-chat","hidden-chat"),e.classList.add(i?"hidden-chat":"visible-chat"),t.innerHTML=i?X:Y,re({...n,isVisible:!i})}}let we=null;function Ee(){const e=document.getElementById("app-chat-container"),t=document.querySelector(".chat-maximize-button");if(e)if(e.classList.contains("maximized")){const n=document.getElementById("messages-panel"),i=n.scrollHeight-n.scrollTop-n.clientHeight<=300;if(e.maximizeResizeHandler&&(window.removeEventListener("resize",e.maximizeResizeHandler),delete e.maximizeResizeHandler),we){e.style.width=`${we.width}px`,e.style.height=`${we.height}px`,e.style.left=`${we.left}px`,e.style.maxWidth="",e.style.minWidth="",e.style.position="absolute",e.style.right="",e.style.margin="",e.style.transform="",e.style.top="auto";if(!e.classList.contains("visible-chat")&&!e.classList.contains("hidden-chat")&&e.classList.remove("visible-chat","hidden-chat"),we.floating){const t=window.innerHeight,n=we.top;n+we.height<=t?e.style.top=`${n}px`:(e.style.bottom="0",e.style.top="auto")}else e.style.bottom="0",e.style.top="";re(we)}e.classList.remove("maximized"),t.classList.remove("maximized"),t.innerHTML=Q,requestAnimationFrame((()=>{ie(),i&&(n.scrollTop=n.scrollHeight)}))}else{const n=!e.classList.contains("visible-chat")&&!e.classList.contains("hidden-chat");we=oe();const i=()=>`${Math.floor(.9*window.innerHeight)}px`;e.style.cssText=`\n      width: 100vw !important;\n      height: ${i()} !important;\n      max-width: 95vw !important;\n      min-width: 95vw !important;\n      position: fixed !important;\n      bottom: 0 !important;\n      left: 0 !important;\n      right: 0 !important;\n      top: auto !important;\n      margin: 0 !important;\n      transform: none !important;\n    `,n&&e.classList.remove("visible-chat","hidden-chat"),e.classList.add("maximized"),t.classList.add("maximized"),t.innerHTML=K;const a=()=>{e.style.height=i(),e.style.bottom="0",e.style.top="auto"};window.addEventListener("resize",a),e.maximizeResizeHandler=a,ie()}}let Le,$e,ke,Se,Ie=!1;let Me,Ce,Te,Ae,ze,He,Ne=!1,Re=null,qe=0;function Be(){const e=new URLSearchParams(window.location.search);if("/g/"===window.location.pathname&&e.has("gmid"))return!1;if(window.location.href.includes("/gamelist/"))return function(){if(window.location.href.startsWith("https://klavogonki.ru/gamelist/"))try{const e=Array.from(document.scripts).find((e=>e.text.includes("PageData")));if(!e)throw new Error("PageData script not found");const t=e.text.match(/\.constant\('PageData', ([\s\S]*?})\)/)[1],n=JSON.parse(t.replace(/(\w+):/g,'"$1":').replace(/'/g,'"')),i=`${n.chatParams.user.id}#${n.chatParams.user.login}`,a=n.chatParams.pass;localStorage.getItem("klavoauth")||(localStorage.setItem("klavoauth",JSON.stringify({username:i,password:a})),setTimeout((()=>{window.location.href="https://klavogonki.ru"}),500))}catch(e){console.error("Auth error:",e),localStorage.removeItem("klavoauth"),alert(`Auth failed: ${e.message}\nPlease refresh the page.`)}}(),!1;return!!(localStorage.getItem("klavoauth")&&v.username&&v.password)||(localStorage.removeItem("klavoauth"),window.location.href="https://klavogonki.ru/gamelist/",!1)}!async function(){try{if(!Be())return;!function(){const e=document.createElement("div");e.id="app-chat-container",["top","left","right"].forEach((t=>{const n=document.createElement("div");n.className=`resize-handle ${t}`,e.appendChild(n)}));const t=document.createElement("div");t.className="chat-wrapper";const n=document.createElement("div");n.className="chat-content";const i=document.createElement("div");i.id="messages-panel",i.className="messages-panel";const a=document.createElement("div");a.className="input-container";const o=document.createElement("input");o.type="text",o.id="message-input";const r=document.createElement("button");r.id="send-button",r.className="filled-button send-button",r.innerHTML=J,a.appendChild(o),a.appendChild(r),n.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.className="user-list-container";const c=document.createElement("div");c.id="user-list",s.appendChild(c),t.appendChild(n),t.appendChild(s),e.appendChild(t);const l=document.createElement("button");l.className="filled-button header-button chat-maximize-button",l.innerHTML=Q,l.addEventListener("click",Ee),e.appendChild(l);const d=document.createElement("button");d.className="filled-button header-button chat-toggle-button",d.innerHTML=Y,d.addEventListener("click",xe),e.appendChild(d);const p=document.createElement("div");p.className="chat-drag-area",p.addEventListener("dblclick",xe),e.appendChild(p),document.body.appendChild(e),ae()}(),function(){const e=document.getElementById("app-chat-container"),t=document.getElementById("chat-close-btn"),n=document.getElementById("chat-header");if(!e)return;const i=JSON.parse(localStorage.getItem("chatState"))||{},a=i.floating||!1,o=!1!==i.isVisible;a?(e.style.display=o?"flex":"none",e.style.opacity=o?"1":"0"):(e.classList.remove("visible-chat","hidden-chat"),e.classList.add(o?"visible-chat":"hidden-chat")),document.addEventListener("keydown",(e=>{e.ctrlKey&&"Space"===e.code&&xe()})),t&&t.addEventListener("click",xe),n&&n.addEventListener("dblclick",xe)}(),document.addEventListener("mousedown",(e=>{if(!e.target.closest(".chat-drag-area"))return;const t=document.getElementById("app-chat-container");let n=oe();if(Ie=!0,Le=e.clientX,$e=e.clientY,ke=t.offsetLeft,Se=parseInt(t.style.top)||t.getBoundingClientRect().top,!n.floating){const e=window.innerHeight-t.offsetHeight;t.style.top=e+"px",t.style.bottom="",n.top=e,n.floating=!0,t.classList.add("floating-chat"),re(n)}document.body.style.userSelect="none"})),document.addEventListener("mousemove",(e=>{if(!Ie)return;const t=document.getElementById("app-chat-container"),n=window.innerWidth,i=window.innerHeight,a=e.clientX-Le,o=e.clientY-$e,r=se(ke+a,0,n-t.offsetWidth),s=se(Se+o,0,i-t.offsetHeight);t.style.left=r+"px",t.style.top=s+"px";let c=oe();c.left=r,c.top=s,c.floating=!0,re(c)})),document.addEventListener("mouseup",(()=>{if(!Ie)return;Ie=!1;const e=document.getElementById("app-chat-container"),t=window.innerWidth,n=window.innerHeight,i=e.getBoundingClientRect(),a=i.left<0||i.top<0||i.right>t||i.bottom>n,o=n-i.bottom<50;let r=oe();a||o?(e.style.top="",e.style.bottom="0",r.floating=!1,e.classList.remove("floating-chat")):(r.floating=!0,r.top=i.top,e.classList.add("floating-chat")),re(r),document.body.style.userSelect=""})),document.addEventListener("mousedown",(e=>{const t=e.target.closest(".resize-handle");if(!t)return;Ne=!0,Re=t.classList[1];const n=document.getElementById("app-chat-container");Me=e.clientX,Ce=e.clientY,Te=n.offsetWidth,Ae=n.offsetHeight,ze=n.offsetLeft,He=parseInt(n.style.top)||n.getBoundingClientRect().top,qe=e.clientY-He,document.body.style.userSelect="none"})),document.addEventListener("mousemove",(e=>{if(!Ne)return;const t=document.getElementById("app-chat-container"),n=window.innerWidth,i=window.innerHeight,a=getComputedStyle(document.documentElement),o=parseInt(a.getPropertyValue("--min-chat-width"))||250,r=parseInt(a.getPropertyValue("--min-chat-height"))||200;let s=oe();if("left"===Re){const i=Math.max(o,Te-(e.clientX-Me)),a=se(ze+(e.clientX-Me),0,n-i);t.style.width=i+"px",t.style.left=a+"px",s.width=i,s.left=a}else if("right"===Re){const i=n-t.getBoundingClientRect().left,a=Math.min(i,Math.max(o,Te+(e.clientX-Me)));t.style.width=a+"px",s.width=a}const c=e.clientY-qe;if("top"===Re)if(!1===s.floating){let e=se(c,0,i-r),n=i-e;t.style.top=e+"px",t.style.height=n+"px",s.top=e,s.height=n}else{let e=se(c,0,He+Ae-r),n=Ae-(e-He);n=Math.min(n,i),t.style.top=e+"px",t.style.height=n+"px",s.top=e,s.height=n}if("left"===Re||"right"===Re)if(!1===s.floating){let e=se(c,0,i-r),n=i-e;t.style.top=e+"px",t.style.height=n+"px",s.top=e,s.height=n}else{let e=se(c,0,He+Ae-r),n=Ae-(e-He);n=Math.min(n,i-e),t.style.top=e+"px",t.style.height=n+"px",s.top=e,s.height=n}t.offsetHeight>i&&(t.style.height=i+"px",!1===s.floating&&(t.style.top="0px",s.top=0),s.height=i),re(s),ie()})),document.addEventListener("mouseup",(()=>{Ne=!1,document.body.style.userSelect=""})),window.addEventListener("resize",(()=>{ae(),ie()})),function(){const e=document.getElementById("messages-panel");if(!e)return;new MutationObserver((()=>{ie(),F(),P(),ye()})).observe(e,{childList:!0,subtree:!0})}();const e=new be("user-list"),t=new ve("messages-panel",v.username),n=function(e,t,n,i){return{userManager:t,messageManager:n,async connect(){try{const a=await e.connect();console.log("ğŸ’¬ Step 8: Joining chat room...");const o=`<body rid='${e.nextRid()}' sid='${a.sid}'\n                 xmlns='http://jabber.org/protocol/httpbind'>\n            <presence id='pres_1' xmlns='jabber:client' to='general@conference.jabber.klavogonki.ru/${i}'>\n              <x xmlns='http://jabber.org/protocol/muc'/>\n            </presence>\n          </body>`,r=await e.sendRequestWithRetry(o);console.log("ğŸ“¥ Join response:",r),t.updatePresence(r),n.processMessages(r);const s=`<body rid='${e.nextRid()}' sid='${a.sid}'\n                 xmlns='http://jabber.org/protocol/httpbind'>\n            <iq type='get' id='info1' xmlns='jabber:client' to='general@conference.jabber.klavogonki.ru'>\n              <query xmlns='http://jabber.org/protocol/disco#info'/>\n            </iq>\n          </body>`;await e.sendRequestWithRetry(s),setInterval((async()=>{const i=await e.sendRequestWithRetry(`<body rid='${e.nextRid()}' sid='${a.sid}' xmlns='http://jabber.org/protocol/httpbind'/>`);t.updatePresence(i),n.processMessages(i)}),5e3),console.log("ğŸš€ Step 10: Connected! Starting presence updates...")}catch(e){console.error(`ğŸ’¥ Error: ${e.message}`)}},sendMessage(t){const i=`msg_${Date.now()}`,a=`\n        <body rid='${e.nextRid()}' sid='${e.sid}' xmlns='http://jabber.org/protocol/httpbind'>\n          <message to='general@conference.jabber.klavogonki.ru'\n                   type='groupchat'\n                   id='${i}'\n                   xmlns='jabber:client'>\n            <body>${t}</body>\n          </message>\n        </body>\n      `;e.sendRequestWithRetry(a).then((e=>{n.processMessages(e)})).catch(console.error)}}}(new L({username:v.username,password:v.password,bindUrl:b,delay:200}),e,t,v.username),i=document.getElementById("message-input"),a=()=>{const e=i.value.trim();e&&(n.sendMessage(e),i.value="",i.focus())};document.getElementById("send-button").addEventListener("click",a),i.addEventListener("keypress",(e=>"Enter"===e.key&&a())),await n.connect(),window.xmppClient=n}catch(e){console.error("App init error:",e),localStorage.removeItem("klavoauth"),window.location.href="https://klavogonki.ru/gamelist/"}}()})();